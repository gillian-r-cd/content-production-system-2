# 代码清理记录 2026-02-14

基于全量代码审查结果，执行以下清理操作。

---

## #1 删除孤岛组件 `simulation-panel.tsx`

**文件**: `frontend/components/simulation-panel.tsx` (1171 行)
**原因**: 该组件未被任何文件 import，是完全的孤岛死代码。`simulate` 阶段已从 `PHASE_DEFINITIONS` 移除，该面板无入口可达。
**操作**: 物理删除文件
**影响范围**: 无。内部依赖的 `simulationAPI`、`settingsAPI` 是公共对象，其他组件仍在使用。

---

## #3 修复 `produce_inner`/`produce_outer` 阶段查找 Bug

**文件**:
- `backend/core/phase_config.py`
- `frontend/lib/utils.ts`
- `backend/core/models/phase_template.py`
- `backend/api/blocks.py`

**问题**: `proposal-selector.tsx` 的 `_findPhaseBlock("produce_inner")` 和 `channel-selector.tsx` 的 `_findProduceOuterParent()` 通过 `special_handler === "produce_inner"` 查找阶段块，但这两个阶段的 `special_handler` 为 `None`，导致查找永远返回 `null`，创建的内容块 `parent_id` 为空，变成项目树顶级节点而非挂在正确阶段下。

**修复方案**: 为 `produce_inner` 和 `produce_outer` 阶段添加 `special_handler`，使查找逻辑生效。

**具体改动**:
1. `phase_config.py`: `produce_inner` 的 `special_handler` 从 `None` 改为 `"produce_inner"`；`produce_outer` 同理
2. `frontend/lib/utils.ts`: 镜像更新前端阶段定义
3. `phase_template.py`: `DEFAULT_PHASE_TEMPLATE` 中对应阶段同步更新
4. `blocks.py`: `phase_handler_map` 添加 `"produce_inner"` 和 `"produce_outer"` 映射

**影响范围**: 已验证以下代码路径不受影响：
- `content-panel.tsx`: 无 `produce_inner`/`produce_outer` 的特殊 UI 路由，走默认"显示子块列表"路径
- `progress-panel.tsx`: `phaseMap` 中无对应条目，`if (phase)` 检查会跳过
- `block-tree.tsx`: `specialHandlerIcons` 中无对应图标，回退到默认图标
- `content-block-editor.tsx`: `b.special_handler` 存在时允许作为依赖项，合理

---

## #4 删除首页 TODO 注释

**文件**: `frontend/app/page.tsx`
**操作**: 删除 `// TODO: 实现项目选择页面` 和 `// 暂时显示欢迎信息` 两行注释
**影响范围**: 无

---

## #6 删除 `simulate` 死代码引用

**文件**:
- `frontend/components/content-block-editor.tsx` (第 1022 行)
- `frontend/components/content-block-card.tsx` (第 973 行)

**原因**: `simulate` 阶段已从 `PHASE_DEFINITIONS` 移除，这两处三元表达式分支永远不会匹配。
**操作**: 删除 `dep.special_handler === "simulate" ? "模拟测试" :` 分支
**影响范围**: 无

---

## #7 删除 `simulate_consumer` 工具别名

**文件**: `frontend/components/agent-panel.tsx` (第 175 行)
**原因**: 后端 `AGENT_TOOLS` 中无 `simulate_consumer` 工具，此映射永远不会被使用。
**操作**: 删除 `simulate_consumer: "run_evaluation"` 行
**影响范围**: 无

---

## #10 从 `DEFAULT_PHASE_TEMPLATE` 移除 `simulate` 阶段

**文件**: `backend/core/models/phase_template.py`
**原因**: `simulate` 阶段已从 `PHASE_DEFINITIONS` 移除，但默认模板仍包含它，导致新建项目多出一个前端无法路由的幽灵阶段。
**操作**: 删除 `simulate` 阶段定义，将 `evaluate` 的 `order_index` 从 7 调整为 6
**影响范围**: 仅影响新建项目。已有项目不受影响。同时更新 description 中的"消费者模拟"描述。

---

## #11 简化 `content-panel.tsx` 冗余条件

**文件**: `frontend/components/content-panel.tsx` (第 80-83 行、第 111 行、第 163 行)
**原因**: `selectedPhase` 就是 `selectedBlock.special_handler` 的别名，`||` 后的条件与前面完全相同。
**操作**: 移除冗余的 `|| selectedPhase === "xxx"` 部分
**影响范围**: 无，纯逻辑等价简化

---

## #12 修复通知图标路径

**文件**: `frontend/lib/utils.ts` (第 181 行)
**原因**: 代码引用 `/favicon.ico` 但该文件不存在，实际图标文件是 `/icon.svg`。
**操作**: 将 `"/favicon.ico"` 改为 `"/icon.svg"`
**影响范围**: 浏览器通知图标从缺失变为正确显示

---

## #16 拆分 settings 页面

**文件**: `frontend/app/settings/page.tsx` (2517 行) → 拆分为多个文件

**方案**: 创建 `frontend/components/settings/` 目录：
- `shared.tsx` — 共享组件：`ImportExportButtons`、`SingleExportButton`、`downloadJSON`、`FormField`、`TagInput`、`KeyValueEditor`
- `system-prompts-section.tsx` — 传统流程提示词管理
- `profiles-section.tsx` — 创作者特质管理
- `templates-section.tsx` — 内容块模板管理
- `phase-templates-section.tsx` — 流程模板管理
- `channels-section.tsx` — 渠道管理
- `simulators-section.tsx` — 模拟器管理
- `graders-section.tsx` — 评分器管理
- `agent-settings-section.tsx` — Agent 设置
- `logs-section.tsx` — 调试日志

**主文件** `settings/page.tsx` 缩减为只包含：Tab 定义、数据加载、Tab 切换、布局渲染。

**附加改动**: `phase-templates-section.tsx` 中的 `SPECIAL_HANDLERS` 下拉选项同步移除 `simulate`，添加 `produce_inner`/`produce_outer`

**影响范围**: 纯重构，零功能变化

---

## 附：`agent-panel.tsx` simulate 清理

**文件**: `frontend/components/agent-panel.tsx`
**操作**:
1. 删除 `TOOL_ID_MIGRATION` 中的 `simulate_consumer` 映射
2. 删除 `TOOLS` 列表中 `simulate_consumer` 工具定义
3. 删除 `PHASES` 列表中 `simulate` 条目

**影响范围**: 无。后端无对应工具/阶段。

---

## 注意：`api.ts` 的 `special_handler` 类型

**文件**: `frontend/lib/api.ts`（on-disk）
**现状**: `ContentBlock.special_handler` 类型为 `string | null`（泛型），不需要改动
**说明**: 如编辑器中存在将其改为 literal union 的未保存修改，需确保包含所有新增 handler：`"intent" | "research" | "design_inner" | "produce_inner" | "design_outer" | "produce_outer" | "evaluate" | null`

---

## 预存在问题（未修改）

以下 `agent-panel.tsx` linter 错误为 **预存在问题**，本次清理未涉及：
- L125: `special_handler` 类型 union 缺少 `"design_inner"` 等值（来自编辑器未保存的类型定义）
- L322/L609: `Expected 1 arguments, but got 2` — 函数签名不匹配
- L1119/L1121/L1125: `tools_used` 应为 `tool_used` — 属性名拼写错误
