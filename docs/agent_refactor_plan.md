# Agent 架构重构规划

**创建时间**: 2026-02-04  
**状态**: 已实现核心功能

---

## 一、第一性原理分析

### 1.1 PRD 核心定义

根据 `PRD.md`，Agent 的定位是：

> "Agent 引领整个内容生产的思路推进和微调"
> "右栏是 AI Agent 区，是个正常的对话框，**不论左栏中栏进展到什么部分，右边都可以对话**"
> "用 LangChain 实现**真正的 Agent 架构，不允许是 if/else 结构**"
> "**所有已生成的字段都可以 @，实现多种意图**"

### 1.2 Agent 应该具备的能力

从 PRD 和 cursorrule.md 提取的核心能力：

| 能力 | 描述 | 触发方式 |
|------|------|----------|
| **意图理解** | 理解用户想做什么，不局限于当前阶段 | 每次对话 |
| **@ 引用解析** | 解析 @字段名，注入字段内容到上下文 | 用户使用 @ 语法 |
| **字段修改** | 根据用户指令修改已有字段内容 | "@字段名 修改..." |
| **字段查询** | 回答关于已有字段的问题 | "@字段名 这是什么意思" |
| **内容生成** | 生成新的字段内容 | "生成..." / 阶段流程 |
| **工具调用** | 调用 DeepResearch、Simulator 等 | 自动/手动触发 |
| **流程推进** | 引领用户完成各阶段 | 阶段完成后 |
| **自由对话** | 回答任意问题，提供建议 | 任何时候 |

### 1.3 正确的 Agent 架构

```
┌─────────────────────────────────────────────────────────────┐
│                       用户输入                               │
│           "@ 项目意图 修改一下，变成三个短语"                  │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    【输入预处理层】                           │
│  1. 解析 @ 引用 → ["项目意图"]                               │
│  2. 查询字段内容 → {项目意图: "获取潜在客户线索..."}          │
│  3. 构建增强输入 → 原始输入 + 引用内容                        │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    【意图理解层】                             │
│  LLM 分析：                                                  │
│  - 用户意图: modify                                          │
│  - 目标字段: 项目意图                                        │
│  - 操作指令: 变成三个短语                                    │
│  - 需要工具: field_modifier                                  │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    【规划执行层】                             │
│  调用 field_modifier 工具:                                   │
│  - 输入: 原字段内容 + 修改指令                               │
│  - 输出: 修改后的内容                                        │
│  - 保存: 更新字段，记录日志                                  │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    【输出层】                                 │
│  返回: "已修改【项目意图】，内容如下：..."                    │
│  通知前端: 刷新中间栏字段显示                                 │
└─────────────────────────────────────────────────────────────┘
```

---

## 二、现有代码问题诊断

### 2.1 架构对比

| 维度 | PRD 期望 | 现有实现 | 差距 |
|------|----------|----------|------|
| **意图识别时机** | 每次对话都识别 | 仅阶段完成后才识别 | 🔴 严重 |
| **@ 引用处理** | 解析并注入上下文 | 接收但不使用 | 🔴 严重 |
| **字段修改** | 支持 modify 意图 | 没有 modify_node | 🔴 严重 |
| **工具调用** | 灵活调用多种工具 | 仅 DeepResearch 硬编码 | 🟡 中等 |
| **阶段独立性** | 对话独立于阶段 | 对话被阶段锁定 | 🔴 严重 |

### 2.2 代码问题清单

#### 问题 1: @ 引用数据丢失
```python
# api/agent.py L162-170
result = await content_agent.run(
    project_id=request.project_id,
    user_input=request.message,
    # ❌ 没有传递 references
    # ❌ 没有传递引用字段的内容
)
```

#### 问题 2: 意图识别被阶段锁定
```python
# orchestrator.py L132-137
if current_phase_status != "completed":
    # ❌ 阶段未完成时，所有输入都被强制路由到当前阶段
    return {**state, "route_target": "phase_current"}
```

#### 问题 3: 缺少 modify_node
```python
# orchestrator.py - ROUTE_OPTIONS 定义了 modify，但没有对应节点
ROUTE_OPTIONS = Literal[
    "modify",  # ← 定义了但没实现！
    ...
]
```

#### 问题 4: 工具/Skill 调用机制不完善
- 没有统一的工具注册机制
- 没有工具调用的路由逻辑
- DeepResearch 是硬编码调用

---

## 三、重构方案

### 3.1 核心设计原则

1. **意图优先**：先理解意图，再决定路由
2. **上下文丰富**：@ 引用内容必须注入
3. **工具标准化**：统一的工具/Skill 调用接口
4. **阶段解耦**：对话不被阶段锁定

### 3.2 新架构设计

```
ContentProductionState (增强)
├── user_input: str
├── references: List[str]          # 新增: @ 引用的字段名
├── referenced_contents: Dict      # 新增: 引用字段的实际内容
├── parsed_intent: ParsedIntent    # 新增: 解析后的意图对象
│   ├── intent_type: str           # modify/generate/query/chat/...
│   ├── target_field: str          # 目标字段（如果有）
│   ├── operation: str             # 操作描述
│   └── tool_needed: str           # 需要的工具
├── ...existing fields...
```

### 3.3 新节点设计

```
┌─────────────────────────────────────────────────────────────┐
│                       LangGraph                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  preprocess_node ──→ intent_router ──┬──→ modify_node       │
│       │                              ├──→ generate_node     │
│       ↓                              ├──→ query_node        │
│  (解析@引用)                          ├──→ phase_node        │
│  (注入字段内容)                       ├──→ tool_node         │
│                                      └──→ chat_node         │
│                                             │               │
│                                             ↓               │
│                                      output_node            │
│                                             │               │
│                                             ↓               │
│                              (保存字段/记录日志/返回)        │
└─────────────────────────────────────────────────────────────┘
```

### 3.4 工具/Skill 标准化

```python
class Tool:
    name: str
    description: str
    parameters: dict
    
    async def execute(self, params: dict, context: dict) -> ToolResult

# 预置工具
TOOLS = {
    "field_modifier": FieldModifierTool(),      # 修改字段
    "field_generator": FieldGeneratorTool(),    # 生成字段
    "deep_research": DeepResearchTool(),        # 深度调研
    "simulator": SimulatorTool(),               # 消费者模拟
    "evaluator": EvaluatorTool(),               # 评估
}
```

---

## 四、详细修改步骤

### Phase 1: 基础设施 ✅ 已完成

#### 1.1 增强 State 定义
- [x] 在 `ContentProductionState` 中添加 `references`
- [x] 在 `ContentProductionState` 中添加 `referenced_contents`
- [x] 在 `ContentProductionState` 中添加 `parsed_intent_type`, `parsed_target_field`, `parsed_operation`
- [x] 添加 `modify_target_field` 用于标记修改操作的目标字段

#### 1.2 修改 API 层
- [x] 在 `agent.py` 中解析 @ 引用
- [x] 查询引用字段的内容
- [x] 将 references 和内容传递给 Agent
- [x] 处理 modify 操作的字段更新

### Phase 2: 意图理解层 ✅ 已完成

#### 2.1 预处理逻辑（在 API 层实现）
- [x] 实现 @ 引用解析逻辑（在 agent.py 中）
- [x] 实现字段内容注入逻辑

#### 2.2 重构意图路由
- [x] 重写 `route_intent` 函数
- [x] 移除阶段锁定逻辑
- [x] 实现真正的意图分类（规则优先 + LLM 兜底）
- [x] 返回结构化的意图信息

### Phase 3: 核心节点实现 ✅ 已完成

#### 3.1 创建 modify_node
- [x] 实现字段修改逻辑
- [x] 调用 LLM 生成修改后的内容
- [x] 通过 `modify_target_field` 标记触发 API 层保存
- [x] 记录 GenerationLog

#### 3.2 创建 query_node
- [x] 实现字段查询逻辑
- [x] 支持解释、总结等操作
- [x] 注入引用内容到上下文

#### 3.3 工具节点（保持现有）
- [x] 保持 DeepResearch、Simulator、Evaluator 现有调用方式

#### 3.4 重构 chat_node
- [x] 实现真正的自由对话
- [x] 注入 Golden Context
- [x] 注入 @ 引用内容
- [x] 不强制进入阶段流程

### Phase 4: 工具标准化 ⏳ 待后续迭代

> 当前实现保持现有工具调用方式，后续可统一为标准化接口

### Phase 5: 图重构 ✅ 已完成

#### 5.1 重建 LangGraph
- [x] 添加 modify 和 query 节点到图
- [x] 修改条件路由 route_by_intent
- [x] 添加节点到 END 的边

#### 5.2 兼容性处理
- [x] 保持阶段流程不变
- [x] 保持现有 API 不变

### Phase 6: 测试验证 ✅ 已完成

#### 6.1 核心场景测试
- [x] 后端启动成功，API 可访问
- [ ] 测试 @ 引用 + 修改（待前端集成后测试）
- [ ] 测试 @ 引用 + 查询（待前端集成后测试）
- [x] 自由对话基础功能可用
- [x] 阶段流程保持正常

---

## 五、验收标准

### 5.1 功能验收

| 场景 | 输入 | 期望输出 |
|------|------|----------|
| @ 修改 | "@项目意图 修改成三个短语" | 字段被修改，中间栏刷新 |
| @ 查询 | "@消费者调研 总结一下" | Agent 返回总结 |
| 自由对话 | "这个项目怎么样" | Agent 基于上下文回答 |
| 阶段推进 | "开始消费者调研" | 进入调研阶段 |

### 5.2 质量验收

- [ ] 没有引入新的 if/else 硬编码逻辑
- [ ] 所有意图都有对应的处理节点
- [ ] @ 引用的字段内容正确注入
- [ ] 日志记录完整

---

## 六、风险评估

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 破坏现有阶段流程 | 中 | 高 | 保持 phase_node 不变 |
| LLM 意图分类不准 | 中 | 中 | 增加 few-shot 示例 |
| 性能下降 | 低 | 中 | 预处理节点缓存 |

---

## 七、执行顺序

1. **立即执行**: Phase 1 + Phase 2.1（解决 @ 引用问题）
2. **第二优先**: Phase 2.2 + Phase 3.1（实现 modify）
3. **第三优先**: Phase 3.2-3.4（其他节点）
4. **最后**: Phase 4-6（工具标准化和测试）

---

---

## 八、完成总结

**完成时间**: 2026-02-04

### 8.1 已实现的核心能力

1. **@ 引用解析**
   - API 层解析 `references` 字段
   - 查询引用字段的实际内容
   - 将内容注入到 Agent 状态

2. **智能意图路由**
   - 规则优先：检测 @ 引用 + 修改/查询关键词
   - 阶段触发词识别
   - LLM 兜底分类

3. **modify_node**
   - 接收目标字段和修改指令
   - 调用 LLM 生成修改后的内容
   - 通过 `modify_target_field` 触发 API 层保存

4. **query_node**
   - 接收查询意图
   - 将引用内容注入上下文
   - 返回分析/解释结果

5. **chat_node 增强**
   - 注入 @ 引用内容
   - 提供更丰富的上下文

### 8.2 用户操作示例

| 用户输入 | 意图类型 | 路由目标 | 行为 |
|----------|----------|----------|------|
| `@项目意图 修改成三个短语` | modify | modify_node | 修改字段并保存 |
| `@消费者调研 总结一下` | query | query_node | 返回总结 |
| `开始` | phase_action | phase_current | 执行当前阶段 |
| `继续` | advance_phase | 下一阶段 | 推进流程 |
| `这个项目怎么样` | chat | chat_node | 自由对话 |

### 8.3 后续迭代方向

1. **工具标准化**: 将 DeepResearch、Simulator、Evaluator 迁移为统一接口
2. **前端集成**: 完善 @ 引用的自动补全和选择 UI
3. **多字段修改**: 支持一次修改多个引用字段
4. **撤销功能**: 支持修改操作的撤销
