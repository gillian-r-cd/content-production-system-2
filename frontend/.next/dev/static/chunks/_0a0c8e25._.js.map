{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/G/vibe_projects/202601_content_production_system_2/frontend/components/layout/workspace-layout.tsx"],"sourcesContent":["// frontend/components/layout/workspace-layout.tsx\r\n// 功能: 工作台三栏布局\r\n// 主要组件: WorkspaceLayout\r\n\r\n\"use client\";\r\n\r\nimport { ReactNode } from \"react\";\r\n\r\ninterface WorkspaceLayoutProps {\r\n  leftPanel: ReactNode;\r\n  centerPanel: ReactNode;\r\n  rightPanel: ReactNode;\r\n}\r\n\r\nexport function WorkspaceLayout({\r\n  leftPanel,\r\n  centerPanel,\r\n  rightPanel,\r\n}: WorkspaceLayoutProps) {\r\n  return (\r\n    <div className=\"flex h-screen bg-surface-0\">\r\n      {/* 左栏：项目进度 */}\r\n      <aside className=\"w-64 flex-shrink-0 border-r border-surface-3 bg-surface-1 overflow-y-auto\">\r\n        {leftPanel}\r\n      </aside>\r\n\r\n      {/* 中栏：内容展示区 */}\r\n      <main className=\"flex-1 overflow-y-auto bg-surface-0\">\r\n        {centerPanel}\r\n      </main>\r\n\r\n      {/* 右栏：AI Agent */}\r\n      <aside className=\"w-96 flex-shrink-0 border-l border-surface-3 bg-surface-1 flex flex-col\">\r\n        {rightPanel}\r\n      </aside>\r\n    </div>\r\n  );\r\n}\r\n\r\n"],"names":[],"mappings":";;;;;AAAA,kDAAkD;AAClD,cAAc;AACd,wBAAwB;AAExB;;AAUO,SAAS,gBAAgB,EAC9B,SAAS,EACT,WAAW,EACX,UAAU,EACW;IACrB,qBACE,6LAAC;QAAI,WAAU;;0BAEb,6LAAC;gBAAM,WAAU;0BACd;;;;;;0BAIH,6LAAC;gBAAK,WAAU;0BACb;;;;;;0BAIH,6LAAC;gBAAM,WAAU;0BACd;;;;;;;;;;;;AAIT;KAvBgB"}},
    {"offset": {"line": 59, "column": 0}, "map": {"version":3,"sources":["file:///D:/G/vibe_projects/202601_content_production_system_2/frontend/lib/utils.ts"],"sourcesContent":["// frontend/lib/utils.ts\r\n// 功能: 通用工具函数\r\n// 主要函数: cn, formatDate\r\n\r\nimport { clsx, type ClassValue } from \"clsx\";\r\nimport { twMerge } from \"tailwind-merge\";\r\n\r\n/**\r\n * 合并 Tailwind 类名\r\n */\r\nexport function cn(...inputs: ClassValue[]) {\r\n  return twMerge(clsx(inputs));\r\n}\r\n\r\n/**\r\n * 格式化日期\r\n */\r\nexport function formatDate(dateString: string): string {\r\n  if (!dateString) return \"\";\r\n  const date = new Date(dateString);\r\n  return date.toLocaleString(\"zh-CN\", {\r\n    year: \"numeric\",\r\n    month: \"2-digit\",\r\n    day: \"2-digit\",\r\n    hour: \"2-digit\",\r\n    minute: \"2-digit\",\r\n  });\r\n}\r\n\r\n/**\r\n * 阶段名称映射\r\n */\r\nexport const PHASE_NAMES: Record<string, string> = {\r\n  intent: \"意图分析\",\r\n  research: \"消费者调研\",\r\n  design_inner: \"内涵设计\",\r\n  produce_inner: \"内涵生产\",\r\n  design_outer: \"外延设计\",\r\n  produce_outer: \"外延生产\",\r\n  simulate: \"消费者模拟\",\r\n  evaluate: \"评估\",\r\n};\r\n\r\n/**\r\n * 阶段状态映射\r\n */\r\nexport const PHASE_STATUS: Record<string, { label: string; color: string }> = {\r\n  pending: { label: \"未开始\", color: \"text-zinc-500\" },\r\n  in_progress: { label: \"进行中\", color: \"text-yellow-500\" },\r\n  completed: { label: \"已完成\", color: \"text-green-500\" },\r\n};\r\n\r\n"],"names":[],"mappings":";;;;;;;;;;AAAA,wBAAwB;AACxB,aAAa;AACb,uBAAuB;AAEvB;AACA;;;AAKO,SAAS,GAAG,GAAG,MAAoB;IACxC,OAAO,IAAA,yKAAO,EAAC,IAAA,gJAAI,EAAC;AACtB;AAKO,SAAS,WAAW,UAAkB;IAC3C,IAAI,CAAC,YAAY,OAAO;IACxB,MAAM,OAAO,IAAI,KAAK;IACtB,OAAO,KAAK,cAAc,CAAC,SAAS;QAClC,MAAM;QACN,OAAO;QACP,KAAK;QACL,MAAM;QACN,QAAQ;IACV;AACF;AAKO,MAAM,cAAsC;IACjD,QAAQ;IACR,UAAU;IACV,cAAc;IACd,eAAe;IACf,cAAc;IACd,eAAe;IACf,UAAU;IACV,UAAU;AACZ;AAKO,MAAM,eAAiE;IAC5E,SAAS;QAAE,OAAO;QAAO,OAAO;IAAgB;IAChD,aAAa;QAAE,OAAO;QAAO,OAAO;IAAkB;IACtD,WAAW;QAAE,OAAO;QAAO,OAAO;IAAiB;AACrD"}},
    {"offset": {"line": 121, "column": 0}, "map": {"version":3,"sources":["file:///D:/G/vibe_projects/202601_content_production_system_2/frontend/components/progress-panel.tsx"],"sourcesContent":["// frontend/components/progress-panel.tsx\n// 功能: 左栏项目进度面板，支持中间4阶段拖拽排序\n// 主要组件: ProgressPanel\n// 固定阶段: 意图分析、消费者调研在顶部；消费者模拟、评估在底部\n// 可拖拽阶段: 内涵设计、内涵生产、外延设计、外延生产\n\n\"use client\";\n\nimport { useState, useRef } from \"react\";\nimport { cn, PHASE_NAMES, PHASE_STATUS } from \"@/lib/utils\";\nimport type { Project } from \"@/lib/api\";\n\n// 固定阶段定义\nconst FIXED_TOP_PHASES = [\"intent\", \"research\"];\nconst DRAGGABLE_PHASES = [\"design_inner\", \"produce_inner\", \"design_outer\", \"produce_outer\"];\nconst FIXED_BOTTOM_PHASES = [\"simulate\", \"evaluate\"];\n\ninterface ProgressPanelProps {\n  project: Project | null;\n  onPhaseClick?: (phase: string) => void;\n  onPhaseReorder?: (phases: string[]) => void;\n  onAutonomyChange?: (autonomy: Record<string, boolean>) => void;\n}\n\nexport function ProgressPanel({\n  project,\n  onPhaseClick,\n  onPhaseReorder,\n  onAutonomyChange,\n}: ProgressPanelProps) {\n  const [showAutonomySettings, setShowAutonomySettings] = useState(false);\n  const allPhases = project?.phase_order || [];\n  const phaseStatus = project?.phase_status || {};\n  const currentPhase = project?.current_phase || \"intent\";\n  \n  // 分离固定和可拖拽阶段\n  const topPhases = allPhases.filter(p => FIXED_TOP_PHASES.includes(p));\n  const middlePhases = allPhases.filter(p => DRAGGABLE_PHASES.includes(p));\n  const bottomPhases = allPhases.filter(p => FIXED_BOTTOM_PHASES.includes(p));\n  \n  // 拖拽状态\n  const [draggedPhase, setDraggedPhase] = useState<string | null>(null);\n  const [dragOverPhase, setDragOverPhase] = useState<string | null>(null);\n  const dragCounter = useRef(0);\n\n  const handleDragStart = (e: React.DragEvent, phase: string) => {\n    setDraggedPhase(phase);\n    e.dataTransfer.effectAllowed = \"move\";\n    e.dataTransfer.setData(\"text/plain\", phase);\n  };\n\n  const handleDragEnd = () => {\n    setDraggedPhase(null);\n    setDragOverPhase(null);\n    dragCounter.current = 0;\n  };\n\n  const handleDragEnter = (e: React.DragEvent, phase: string) => {\n    e.preventDefault();\n    dragCounter.current++;\n    if (DRAGGABLE_PHASES.includes(phase)) {\n      setDragOverPhase(phase);\n    }\n  };\n\n  const handleDragLeave = () => {\n    dragCounter.current--;\n    if (dragCounter.current === 0) {\n      setDragOverPhase(null);\n    }\n  };\n\n  const handleDragOver = (e: React.DragEvent) => {\n    e.preventDefault();\n  };\n\n  const handleDrop = (e: React.DragEvent, targetPhase: string) => {\n    e.preventDefault();\n    \n    if (!draggedPhase || draggedPhase === targetPhase) {\n      handleDragEnd();\n      return;\n    }\n    \n    // 重新排序中间阶段\n    const newMiddle = [...middlePhases];\n    const dragIdx = newMiddle.indexOf(draggedPhase);\n    const dropIdx = newMiddle.indexOf(targetPhase);\n    \n    if (dragIdx !== -1 && dropIdx !== -1) {\n      newMiddle.splice(dragIdx, 1);\n      newMiddle.splice(dropIdx, 0, draggedPhase);\n      \n      // 重建完整顺序\n      const newOrder = [...topPhases, ...newMiddle, ...bottomPhases];\n      onPhaseReorder?.(newOrder);\n    }\n    \n    handleDragEnd();\n  };\n\n  const renderPhaseItem = (phase: string, isDraggable: boolean) => {\n    const status = phaseStatus[phase] || \"pending\";\n    const statusInfo = PHASE_STATUS[status] || PHASE_STATUS.pending;\n    const isCurrent = phase === currentPhase;\n    const isDragging = draggedPhase === phase;\n    const isDragOver = dragOverPhase === phase;\n    \n    return (\n      <div\n        key={phase}\n        draggable={isDraggable}\n        onDragStart={isDraggable ? (e) => handleDragStart(e, phase) : undefined}\n        onDragEnd={isDraggable ? handleDragEnd : undefined}\n        onDragEnter={isDraggable ? (e) => handleDragEnter(e, phase) : undefined}\n        onDragLeave={isDraggable ? handleDragLeave : undefined}\n        onDragOver={isDraggable ? handleDragOver : undefined}\n        onDrop={isDraggable ? (e) => handleDrop(e, phase) : undefined}\n        className={cn(\n          \"relative transition-all duration-150\",\n          isDragging && \"opacity-50\",\n          isDragOver && \"before:absolute before:inset-x-0 before:-top-1 before:h-0.5 before:bg-brand-500\"\n        )}\n      >\n        <button\n          onClick={() => onPhaseClick?.(phase)}\n          className={cn(\n            \"w-full flex items-center gap-3 px-3 py-2 rounded-lg text-left transition-colors\",\n            isCurrent\n              ? \"bg-brand-600/20 text-brand-400\"\n              : \"hover:bg-surface-3 text-zinc-300\",\n            isDraggable && \"cursor-grab active:cursor-grabbing\"\n          )}\n        >\n          {/* 拖拽手柄 */}\n          {isDraggable && (\n            <span className=\"text-zinc-600 text-xs select-none\">⋮⋮</span>\n          )}\n          \n          {/* 状态指示器 */}\n          <div\n            className={cn(\n              \"w-2 h-2 rounded-full flex-shrink-0\",\n              status === \"completed\" && \"bg-green-500\",\n              status === \"in_progress\" && \"bg-yellow-500\",\n              status === \"pending\" && \"bg-zinc-600\"\n            )}\n          />\n          \n          {/* 阶段名称 */}\n          <span className=\"flex-1 text-sm\">\n            {PHASE_NAMES[phase] || phase}\n          </span>\n          \n          {/* 状态标签 */}\n          <span className={cn(\"text-xs\", statusInfo.color)}>\n            {statusInfo.label}\n          </span>\n        </button>\n      </div>\n    );\n  };\n\n  return (\n    <div className=\"p-4\">\n      {/* 项目信息 */}\n      <div className=\"mb-6\">\n        <h2 className=\"text-lg font-semibold text-zinc-100\">\n          {project?.name || \"未选择项目\"}\n        </h2>\n        {project && (\n          <p className=\"text-sm text-zinc-500 mt-1\">\n            版本 {project.version}\n          </p>\n        )}\n      </div>\n\n      {/* 流程进度 */}\n      <div className=\"space-y-1\">\n        <h3 className=\"text-xs font-medium text-zinc-500 uppercase tracking-wider mb-3\">\n          流程进度\n        </h3>\n        \n        {/* 顶部固定阶段 */}\n        {topPhases.map(phase => renderPhaseItem(phase, false))}\n        \n        {/* 可拖拽的中间阶段 */}\n        {middlePhases.length > 0 && (\n          <div className=\"py-1\">\n            <div className=\"text-xs text-zinc-600 px-3 mb-1 flex items-center gap-1\">\n              <span>↕</span>\n              <span>可拖拽调整顺序</span>\n            </div>\n            {middlePhases.map(phase => renderPhaseItem(phase, true))}\n          </div>\n        )}\n        \n        {/* 底部固定阶段 */}\n        {bottomPhases.map(phase => renderPhaseItem(phase, false))}\n      </div>\n\n      {/* 分隔线 */}\n      <div className=\"my-6 border-t border-surface-3\" />\n\n      {/* 快捷操作 */}\n      <div className=\"space-y-2\">\n        <h3 className=\"text-xs font-medium text-zinc-500 uppercase tracking-wider mb-3\">\n          快捷操作\n        </h3>\n        \n        <button \n          onClick={() => setShowAutonomySettings(true)}\n          className=\"w-full px-3 py-2 text-sm text-left text-zinc-400 hover:text-zinc-200 hover:bg-surface-3 rounded-lg transition-colors\"\n        >\n          ⚙ Agent自主权设置\n        </button>\n        \n        <button className=\"w-full px-3 py-2 text-sm text-left text-zinc-400 hover:text-zinc-200 hover:bg-surface-3 rounded-lg transition-colors\">\n          + 新建版本\n        </button>\n        \n        <button className=\"w-full px-3 py-2 text-sm text-left text-zinc-400 hover:text-zinc-200 hover:bg-surface-3 rounded-lg transition-colors\">\n          查看历史版本\n        </button>\n        \n        <button className=\"w-full px-3 py-2 text-sm text-left text-zinc-400 hover:text-zinc-200 hover:bg-surface-3 rounded-lg transition-colors\">\n          导出内容\n        </button>\n      </div>\n\n      {/* Agent自主权设置弹窗 */}\n      {showAutonomySettings && project && (\n        <AutonomySettingsModal\n          project={project}\n          onClose={() => setShowAutonomySettings(false)}\n          onSave={onAutonomyChange}\n        />\n      )}\n    </div>\n  );\n}\n\ninterface AutonomySettingsModalProps {\n  project: Project;\n  onClose: () => void;\n  onSave?: (autonomy: Record<string, boolean>) => void;\n}\n\nfunction AutonomySettingsModal({ project, onClose, onSave }: AutonomySettingsModalProps) {\n  const [autonomy, setAutonomy] = useState<Record<string, boolean>>(\n    project.agent_autonomy || {}\n  );\n\n  const allPhases = [\n    { id: \"intent\", name: \"意图分析\", desc: \"Agent自动提问并分析意图\" },\n    { id: \"research\", name: \"消费者调研\", desc: \"Agent自动调研用户画像\" },\n    { id: \"design_inner\", name: \"内涵设计\", desc: \"Agent自动设计内容方案\" },\n    { id: \"produce_inner\", name: \"内涵生产\", desc: \"Agent自动生产各字段内容\" },\n    { id: \"design_outer\", name: \"外延设计\", desc: \"Agent自动设计传播方案\" },\n    { id: \"produce_outer\", name: \"外延生产\", desc: \"Agent自动生产渠道内容\" },\n    { id: \"simulate\", name: \"消费者模拟\", desc: \"Agent自动模拟用户体验\" },\n    { id: \"evaluate\", name: \"评估\", desc: \"Agent自动评估内容质量\" },\n  ];\n\n  const handleToggle = (phase: string) => {\n    setAutonomy((prev) => ({\n      ...prev,\n      [phase]: !prev[phase],\n    }));\n  };\n\n  const handleSave = () => {\n    onSave?.(autonomy);\n    onClose();\n  };\n\n  return (\n    <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\n      <div className=\"bg-surface-2 rounded-xl border border-surface-3 w-full max-w-lg max-h-[80vh] overflow-hidden\">\n        <div className=\"px-4 py-3 border-b border-surface-3\">\n          <h3 className=\"font-medium text-zinc-200\">Agent自主权设置</h3>\n          <p className=\"text-xs text-zinc-500 mt-1\">\n            设置各阶段Agent是否自动执行，不勾选 = 需要人工确认后才继续\n          </p>\n        </div>\n\n        <div className=\"p-4 max-h-[50vh] overflow-y-auto space-y-3\">\n          {allPhases.map((phase) => (\n            <label\n              key={phase.id}\n              className=\"flex items-start gap-3 p-3 rounded-lg hover:bg-surface-3 cursor-pointer\"\n            >\n              <input\n                type=\"checkbox\"\n                checked={autonomy[phase.id] !== false}\n                onChange={() => handleToggle(phase.id)}\n                className=\"mt-0.5 rounded\"\n              />\n              <div className=\"flex-1\">\n                <div className=\"text-sm text-zinc-200\">{phase.name}</div>\n                <div className=\"text-xs text-zinc-500 mt-0.5\">{phase.desc}</div>\n              </div>\n              <span className={`text-xs px-2 py-0.5 rounded ${\n                autonomy[phase.id] !== false\n                  ? \"bg-green-600/20 text-green-400\"\n                  : \"bg-yellow-600/20 text-yellow-400\"\n              }`}>\n                {autonomy[phase.id] !== false ? \"自动\" : \"需确认\"}\n              </span>\n            </label>\n          ))}\n        </div>\n\n        <div className=\"px-4 py-3 border-t border-surface-3 flex justify-between\">\n          <div className=\"flex gap-2\">\n            <button\n              onClick={() => setAutonomy(allPhases.reduce((acc, p) => ({ ...acc, [p.id]: true }), {}))}\n              className=\"px-3 py-1.5 text-xs bg-surface-3 hover:bg-surface-4 rounded-lg\"\n            >\n              全部自动\n            </button>\n            <button\n              onClick={() => setAutonomy(allPhases.reduce((acc, p) => ({ ...acc, [p.id]: false }), {}))}\n              className=\"px-3 py-1.5 text-xs bg-surface-3 hover:bg-surface-4 rounded-lg\"\n            >\n              全部确认\n            </button>\n          </div>\n          <div className=\"flex gap-2\">\n            <button\n              onClick={onClose}\n              className=\"px-4 py-2 text-sm bg-surface-3 hover:bg-surface-4 rounded-lg\"\n            >\n              取消\n            </button>\n            <button\n              onClick={handleSave}\n              className=\"px-4 py-2 text-sm bg-brand-600 hover:bg-brand-700 rounded-lg\"\n            >\n              保存\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n"],"names":[],"mappings":";;;;;AAQA;AACA;;;AATA,yCAAyC;AACzC,2BAA2B;AAC3B,sBAAsB;AACtB,kCAAkC;AAClC,6BAA6B;AAE7B;;;AAMA,SAAS;AACT,MAAM,mBAAmB;IAAC;IAAU;CAAW;AAC/C,MAAM,mBAAmB;IAAC;IAAgB;IAAiB;IAAgB;CAAgB;AAC3F,MAAM,sBAAsB;IAAC;IAAY;CAAW;AAS7C,SAAS,cAAc,EAC5B,OAAO,EACP,YAAY,EACZ,cAAc,EACd,gBAAgB,EACG;;IACnB,MAAM,CAAC,sBAAsB,wBAAwB,GAAG,IAAA,yKAAQ,EAAC;IACjE,MAAM,YAAY,SAAS,eAAe,EAAE;IAC5C,MAAM,cAAc,SAAS,gBAAgB,CAAC;IAC9C,MAAM,eAAe,SAAS,iBAAiB;IAE/C,aAAa;IACb,MAAM,YAAY,UAAU,MAAM,CAAC,CAAA,IAAK,iBAAiB,QAAQ,CAAC;IAClE,MAAM,eAAe,UAAU,MAAM,CAAC,CAAA,IAAK,iBAAiB,QAAQ,CAAC;IACrE,MAAM,eAAe,UAAU,MAAM,CAAC,CAAA,IAAK,oBAAoB,QAAQ,CAAC;IAExE,OAAO;IACP,MAAM,CAAC,cAAc,gBAAgB,GAAG,IAAA,yKAAQ,EAAgB;IAChE,MAAM,CAAC,eAAe,iBAAiB,GAAG,IAAA,yKAAQ,EAAgB;IAClE,MAAM,cAAc,IAAA,uKAAM,EAAC;IAE3B,MAAM,kBAAkB,CAAC,GAAoB;QAC3C,gBAAgB;QAChB,EAAE,YAAY,CAAC,aAAa,GAAG;QAC/B,EAAE,YAAY,CAAC,OAAO,CAAC,cAAc;IACvC;IAEA,MAAM,gBAAgB;QACpB,gBAAgB;QAChB,iBAAiB;QACjB,YAAY,OAAO,GAAG;IACxB;IAEA,MAAM,kBAAkB,CAAC,GAAoB;QAC3C,EAAE,cAAc;QAChB,YAAY,OAAO;QACnB,IAAI,iBAAiB,QAAQ,CAAC,QAAQ;YACpC,iBAAiB;QACnB;IACF;IAEA,MAAM,kBAAkB;QACtB,YAAY,OAAO;QACnB,IAAI,YAAY,OAAO,KAAK,GAAG;YAC7B,iBAAiB;QACnB;IACF;IAEA,MAAM,iBAAiB,CAAC;QACtB,EAAE,cAAc;IAClB;IAEA,MAAM,aAAa,CAAC,GAAoB;QACtC,EAAE,cAAc;QAEhB,IAAI,CAAC,gBAAgB,iBAAiB,aAAa;YACjD;YACA;QACF;QAEA,WAAW;QACX,MAAM,YAAY;eAAI;SAAa;QACnC,MAAM,UAAU,UAAU,OAAO,CAAC;QAClC,MAAM,UAAU,UAAU,OAAO,CAAC;QAElC,IAAI,YAAY,CAAC,KAAK,YAAY,CAAC,GAAG;YACpC,UAAU,MAAM,CAAC,SAAS;YAC1B,UAAU,MAAM,CAAC,SAAS,GAAG;YAE7B,SAAS;YACT,MAAM,WAAW;mBAAI;mBAAc;mBAAc;aAAa;YAC9D,iBAAiB;QACnB;QAEA;IACF;IAEA,MAAM,kBAAkB,CAAC,OAAe;QACtC,MAAM,SAAS,WAAW,CAAC,MAAM,IAAI;QACrC,MAAM,aAAa,+HAAY,CAAC,OAAO,IAAI,+HAAY,CAAC,OAAO;QAC/D,MAAM,YAAY,UAAU;QAC5B,MAAM,aAAa,iBAAiB;QACpC,MAAM,aAAa,kBAAkB;QAErC,qBACE,6LAAC;YAEC,WAAW;YACX,aAAa,cAAc,CAAC,IAAM,gBAAgB,GAAG,SAAS;YAC9D,WAAW,cAAc,gBAAgB;YACzC,aAAa,cAAc,CAAC,IAAM,gBAAgB,GAAG,SAAS;YAC9D,aAAa,cAAc,kBAAkB;YAC7C,YAAY,cAAc,iBAAiB;YAC3C,QAAQ,cAAc,CAAC,IAAM,WAAW,GAAG,SAAS;YACpD,WAAW,IAAA,qHAAE,EACX,wCACA,cAAc,cACd,cAAc;sBAGhB,cAAA,6LAAC;gBACC,SAAS,IAAM,eAAe;gBAC9B,WAAW,IAAA,qHAAE,EACX,mFACA,YACI,mCACA,oCACJ,eAAe;;oBAIhB,6BACC,6LAAC;wBAAK,WAAU;kCAAoC;;;;;;kCAItD,6LAAC;wBACC,WAAW,IAAA,qHAAE,EACX,sCACA,WAAW,eAAe,gBAC1B,WAAW,iBAAiB,iBAC5B,WAAW,aAAa;;;;;;kCAK5B,6LAAC;wBAAK,WAAU;kCACb,8HAAW,CAAC,MAAM,IAAI;;;;;;kCAIzB,6LAAC;wBAAK,WAAW,IAAA,qHAAE,EAAC,WAAW,WAAW,KAAK;kCAC5C,WAAW,KAAK;;;;;;;;;;;;WA9ChB;;;;;IAmDX;IAEA,qBACE,6LAAC;QAAI,WAAU;;0BAEb,6LAAC;gBAAI,WAAU;;kCACb,6LAAC;wBAAG,WAAU;kCACX,SAAS,QAAQ;;;;;;oBAEnB,yBACC,6LAAC;wBAAE,WAAU;;4BAA6B;4BACpC,QAAQ,OAAO;;;;;;;;;;;;;0BAMzB,6LAAC;gBAAI,WAAU;;kCACb,6LAAC;wBAAG,WAAU;kCAAkE;;;;;;oBAK/E,UAAU,GAAG,CAAC,CAAA,QAAS,gBAAgB,OAAO;oBAG9C,aAAa,MAAM,GAAG,mBACrB,6LAAC;wBAAI,WAAU;;0CACb,6LAAC;gCAAI,WAAU;;kDACb,6LAAC;kDAAK;;;;;;kDACN,6LAAC;kDAAK;;;;;;;;;;;;4BAEP,aAAa,GAAG,CAAC,CAAA,QAAS,gBAAgB,OAAO;;;;;;;oBAKrD,aAAa,GAAG,CAAC,CAAA,QAAS,gBAAgB,OAAO;;;;;;;0BAIpD,6LAAC;gBAAI,WAAU;;;;;;0BAGf,6LAAC;gBAAI,WAAU;;kCACb,6LAAC;wBAAG,WAAU;kCAAkE;;;;;;kCAIhF,6LAAC;wBACC,SAAS,IAAM,wBAAwB;wBACvC,WAAU;kCACX;;;;;;kCAID,6LAAC;wBAAO,WAAU;kCAAuH;;;;;;kCAIzI,6LAAC;wBAAO,WAAU;kCAAuH;;;;;;kCAIzI,6LAAC;wBAAO,WAAU;kCAAuH;;;;;;;;;;;;YAM1I,wBAAwB,yBACvB,6LAAC;gBACC,SAAS;gBACT,SAAS,IAAM,wBAAwB;gBACvC,QAAQ;;;;;;;;;;;;AAKlB;GAxNgB;KAAA;AAgOhB,SAAS,sBAAsB,EAAE,OAAO,EAAE,OAAO,EAAE,MAAM,EAA8B;;IACrF,MAAM,CAAC,UAAU,YAAY,GAAG,IAAA,yKAAQ,EACtC,QAAQ,cAAc,IAAI,CAAC;IAG7B,MAAM,YAAY;QAChB;YAAE,IAAI;YAAU,MAAM;YAAQ,MAAM;QAAiB;QACrD;YAAE,IAAI;YAAY,MAAM;YAAS,MAAM;QAAgB;QACvD;YAAE,IAAI;YAAgB,MAAM;YAAQ,MAAM;QAAgB;QAC1D;YAAE,IAAI;YAAiB,MAAM;YAAQ,MAAM;QAAiB;QAC5D;YAAE,IAAI;YAAgB,MAAM;YAAQ,MAAM;QAAgB;QAC1D;YAAE,IAAI;YAAiB,MAAM;YAAQ,MAAM;QAAgB;QAC3D;YAAE,IAAI;YAAY,MAAM;YAAS,MAAM;QAAgB;QACvD;YAAE,IAAI;YAAY,MAAM;YAAM,MAAM;QAAgB;KACrD;IAED,MAAM,eAAe,CAAC;QACpB,YAAY,CAAC,OAAS,CAAC;gBACrB,GAAG,IAAI;gBACP,CAAC,MAAM,EAAE,CAAC,IAAI,CAAC,MAAM;YACvB,CAAC;IACH;IAEA,MAAM,aAAa;QACjB,SAAS;QACT;IACF;IAEA,qBACE,6LAAC;QAAI,WAAU;kBACb,cAAA,6LAAC;YAAI,WAAU;;8BACb,6LAAC;oBAAI,WAAU;;sCACb,6LAAC;4BAAG,WAAU;sCAA4B;;;;;;sCAC1C,6LAAC;4BAAE,WAAU;sCAA6B;;;;;;;;;;;;8BAK5C,6LAAC;oBAAI,WAAU;8BACZ,UAAU,GAAG,CAAC,CAAC,sBACd,6LAAC;4BAEC,WAAU;;8CAEV,6LAAC;oCACC,MAAK;oCACL,SAAS,QAAQ,CAAC,MAAM,EAAE,CAAC,KAAK;oCAChC,UAAU,IAAM,aAAa,MAAM,EAAE;oCACrC,WAAU;;;;;;8CAEZ,6LAAC;oCAAI,WAAU;;sDACb,6LAAC;4CAAI,WAAU;sDAAyB,MAAM,IAAI;;;;;;sDAClD,6LAAC;4CAAI,WAAU;sDAAgC,MAAM,IAAI;;;;;;;;;;;;8CAE3D,6LAAC;oCAAK,WAAW,CAAC,4BAA4B,EAC5C,QAAQ,CAAC,MAAM,EAAE,CAAC,KAAK,QACnB,mCACA,oCACJ;8CACC,QAAQ,CAAC,MAAM,EAAE,CAAC,KAAK,QAAQ,OAAO;;;;;;;2BAlBpC,MAAM,EAAE;;;;;;;;;;8BAwBnB,6LAAC;oBAAI,WAAU;;sCACb,6LAAC;4BAAI,WAAU;;8CACb,6LAAC;oCACC,SAAS,IAAM,YAAY,UAAU,MAAM,CAAC,CAAC,KAAK,IAAM,CAAC;gDAAE,GAAG,GAAG;gDAAE,CAAC,EAAE,EAAE,CAAC,EAAE;4CAAK,CAAC,GAAG,CAAC;oCACrF,WAAU;8CACX;;;;;;8CAGD,6LAAC;oCACC,SAAS,IAAM,YAAY,UAAU,MAAM,CAAC,CAAC,KAAK,IAAM,CAAC;gDAAE,GAAG,GAAG;gDAAE,CAAC,EAAE,EAAE,CAAC,EAAE;4CAAM,CAAC,GAAG,CAAC;oCACtF,WAAU;8CACX;;;;;;;;;;;;sCAIH,6LAAC;4BAAI,WAAU;;8CACb,6LAAC;oCACC,SAAS;oCACT,WAAU;8CACX;;;;;;8CAGD,6LAAC;oCACC,SAAS;oCACT,WAAU;8CACX;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAQb;IAlGS;MAAA"}},
    {"offset": {"line": 675, "column": 0}, "map": {"version":3,"sources":["file:///D:/G/vibe_projects/202601_content_production_system_2/frontend/lib/api.ts"],"sourcesContent":["// frontend/lib/api.ts\n// 功能: API客户端，封装后端API调用\n// 主要函数: fetchAPI, streamAPI\n// 数据结构: Project, Field, ChatMessage\n\nconst API_BASE = process.env.BACKEND_URL || \"http://localhost:8000\";\n\n// ============== Types ==============\n\nexport interface Project {\n  id: string;\n  name: string;\n  version: number;\n  version_note: string;\n  creator_profile_id: string | null;\n  current_phase: string;\n  phase_order: string[];\n  phase_status: Record<string, string>;\n  agent_autonomy: Record<string, boolean>;\n  golden_context: Record<string, string>;\n  use_deep_research: boolean;\n  created_at: string;\n  updated_at: string;\n}\n\nexport interface Field {\n  id: string;\n  project_id: string;\n  phase: string;\n  name: string;\n  field_type: string;\n  content: string;\n  status: string;\n  ai_prompt: string;\n  pre_questions: string[];\n  pre_answers: Record<string, string>;\n  dependencies: {\n    depends_on: string[];\n    dependency_type: string;\n  };\n  template_id: string | null;\n  created_at: string;\n  updated_at: string;\n}\n\nexport interface CreatorProfile {\n  id: string;\n  name: string;\n  description: string;\n  traits: Record<string, any>;\n  created_at: string;\n}\n\nexport interface ChatMessage {\n  role: \"user\" | \"assistant\";\n  content: string;\n}\n\nexport interface ChatResponse {\n  message_id: string;\n  message: string;\n  phase: string;\n  phase_status: Record<string, string>;\n  waiting_for_human: boolean;\n}\n\nexport interface ChatMessageRecord {\n  id: string;\n  role: \"user\" | \"assistant\";\n  content: string;\n  original_content: string;\n  is_edited: boolean;\n  metadata: {\n    phase?: string;\n    tool_used?: string;\n    skill_used?: string;\n    references?: string[];\n    is_retry?: boolean;\n  };\n  created_at: string;\n}\n\nexport interface Persona {\n  source: string;\n  name: string;\n  background: string;\n  story: string;\n}\n\nexport interface SimulationRecord {\n  id: string;\n  project_id: string;\n  simulator_id: string;\n  target_field_ids: string[];\n  persona: Persona;\n  interaction_log: any[];\n  feedback: {\n    scores: Record<string, number>;\n    comments: Record<string, string>;\n    overall: string;\n  };\n  status: string;\n  created_at: string;\n}\n\nexport interface PersonaFromResearch {\n  name: string;\n  background: string;\n  story: string;\n}\n\n// ============== API Functions ==============\n\nasync function fetchAPI<T>(\n  endpoint: string,\n  options: RequestInit = {}\n): Promise<T> {\n  const url = `${API_BASE}${endpoint}`;\n  \n  const response = await fetch(url, {\n    ...options,\n    headers: {\n      \"Content-Type\": \"application/json\",\n      ...options.headers,\n    },\n  });\n\n  if (!response.ok) {\n    const error = await response.json().catch(() => ({ detail: \"Unknown error\" }));\n    // 处理Pydantic验证错误格式 (detail可能是数组)\n    let errorMessage: string;\n    if (typeof error.detail === \"string\") {\n      errorMessage = error.detail;\n    } else if (Array.isArray(error.detail)) {\n      errorMessage = error.detail.map((e: any) => e.msg || e.message || JSON.stringify(e)).join(\"; \");\n    } else {\n      errorMessage = `API error: ${response.status}`;\n    }\n    throw new Error(errorMessage);\n  }\n\n  return response.json();\n}\n\n// ============== Project API ==============\n\nexport const projectAPI = {\n  list: () => fetchAPI<Project[]>(\"/api/projects/\"),\n  \n  get: (id: string) => fetchAPI<Project>(`/api/projects/${id}`),\n  \n  create: (data: { name: string; creator_profile_id?: string; use_deep_research?: boolean }) =>\n    fetchAPI<Project>(\"/api/projects/\", {\n      method: \"POST\",\n      body: JSON.stringify(data),\n    }),\n  \n  update: (id: string, data: Partial<Project>) =>\n    fetchAPI<Project>(`/api/projects/${id}`, {\n      method: \"PUT\",\n      body: JSON.stringify(data),\n    }),\n  \n  delete: (id: string) =>\n    fetchAPI<{ message: string }>(`/api/projects/${id}`, { method: \"DELETE\" }),\n  \n  createVersion: (id: string, version_note: string) =>\n    fetchAPI<Project>(`/api/projects/${id}/versions`, {\n      method: \"POST\",\n      body: JSON.stringify({ version_note }),\n    }),\n};\n\n// ============== Field API ==============\n\nexport const fieldAPI = {\n  listByProject: (projectId: string, phase?: string) => {\n    const query = phase ? `?phase=${phase}` : \"\";\n    return fetchAPI<Field[]>(`/api/fields/project/${projectId}${query}`);\n  },\n  \n  get: (id: string) => fetchAPI<Field>(`/api/fields/${id}`),\n  \n  create: (data: Partial<Field>) =>\n    fetchAPI<Field>(\"/api/fields/\", {\n      method: \"POST\",\n      body: JSON.stringify(data),\n    }),\n  \n  update: (id: string, data: Partial<Field>) =>\n    fetchAPI<Field>(`/api/fields/${id}`, {\n      method: \"PUT\",\n      body: JSON.stringify(data),\n    }),\n  \n  delete: (id: string) =>\n    fetchAPI<{ message: string }>(`/api/fields/${id}`, { method: \"DELETE\" }),\n  \n  generate: (id: string, pre_answers: Record<string, string> = {}) =>\n    fetchAPI<Field>(`/api/fields/${id}/generate`, {\n      method: \"POST\",\n      body: JSON.stringify({ pre_answers }),\n    }),\n};\n\n// ============== Agent API ==============\n\nexport const agentAPI = {\n  chat: (projectId: string, message: string, currentPhase?: string) =>\n    fetchAPI<ChatResponse>(\"/api/agent/chat\", {\n      method: \"POST\",\n      body: JSON.stringify({\n        project_id: projectId,\n        message,\n        current_phase: currentPhase,\n      }),\n    }),\n  \n  advance: (projectId: string) =>\n    fetchAPI<ChatResponse>(\"/api/agent/advance\", {\n      method: \"POST\",\n      body: JSON.stringify({\n        project_id: projectId,\n        message: \"继续\",\n      }),\n    }),\n  \n  stream: async function* (\n    projectId: string,\n    message: string,\n    currentPhase?: string\n  ): AsyncGenerator<{ node?: string; content?: string; done?: boolean; error?: string }> {\n    const response = await fetch(`${API_BASE}/api/agent/stream`, {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify({\n        project_id: projectId,\n        message,\n        current_phase: currentPhase,\n      }),\n    });\n\n    const reader = response.body?.getReader();\n    const decoder = new TextDecoder();\n\n    if (!reader) return;\n\n    while (true) {\n      const { done, value } = await reader.read();\n      if (done) break;\n\n      const text = decoder.decode(value);\n      const lines = text.split(\"\\n\");\n\n      for (const line of lines) {\n        if (line.startsWith(\"data: \")) {\n          try {\n            const data = JSON.parse(line.slice(6));\n            yield data;\n          } catch {\n            // Ignore parse errors\n          }\n        }\n      }\n    }\n  },\n\n  // 获取对话历史\n  getHistory: (projectId: string, limit: number = 100) =>\n    fetchAPI<ChatMessageRecord[]>(`/api/agent/history/${projectId}?limit=${limit}`),\n  \n  // 编辑消息\n  editMessage: (messageId: string, content: string) =>\n    fetchAPI<ChatMessageRecord>(`/api/agent/message/${messageId}`, {\n      method: \"PUT\",\n      body: JSON.stringify({ content }),\n    }),\n  \n  // 重试/再试一次\n  retryMessage: (messageId: string) =>\n    fetchAPI<ChatResponse>(`/api/agent/retry/${messageId}`, {\n      method: \"POST\",\n    }),\n  \n  // 删除消息\n  deleteMessage: (messageId: string) =>\n    fetchAPI<any>(`/api/agent/message/${messageId}`, { method: \"DELETE\" }),\n  \n  // 调用Tool\n  callTool: (projectId: string, toolName: string, parameters: Record<string, any> = {}) =>\n    fetchAPI<ChatResponse>(\"/api/agent/tool\", {\n      method: \"POST\",\n      body: JSON.stringify({\n        project_id: projectId,\n        tool_name: toolName,\n        parameters,\n      }),\n    }),\n};\n\n// ============== Settings API ==============\n\nexport const settingsAPI = {\n  // System Prompts\n  listSystemPrompts: () =>\n    fetchAPI<any[]>(\"/api/settings/system-prompts\"),\n  \n  updateSystemPrompt: (id: string, data: any) =>\n    fetchAPI<any>(`/api/settings/system-prompts/${id}`, {\n      method: \"PUT\",\n      body: JSON.stringify(data),\n    }),\n\n  // Creator Profiles\n  listCreatorProfiles: () =>\n    fetchAPI<CreatorProfile[]>(\"/api/settings/creator-profiles\"),\n  \n  createCreatorProfile: (data: Partial<CreatorProfile>) =>\n    fetchAPI<CreatorProfile>(\"/api/settings/creator-profiles\", {\n      method: \"POST\",\n      body: JSON.stringify(data),\n    }),\n  \n  updateCreatorProfile: (id: string, data: Partial<CreatorProfile>) =>\n    fetchAPI<CreatorProfile>(`/api/settings/creator-profiles/${id}`, {\n      method: \"PUT\",\n      body: JSON.stringify(data),\n    }),\n  \n  deleteCreatorProfile: (id: string) =>\n    fetchAPI<any>(`/api/settings/creator-profiles/${id}`, { method: \"DELETE\" }),\n  \n  // Field Templates\n  listFieldTemplates: () =>\n    fetchAPI<any[]>(\"/api/settings/field-templates\"),\n  \n  createFieldTemplate: (data: any) =>\n    fetchAPI<any>(\"/api/settings/field-templates\", {\n      method: \"POST\",\n      body: JSON.stringify(data),\n    }),\n  \n  updateFieldTemplate: (id: string, data: any) =>\n    fetchAPI<any>(`/api/settings/field-templates/${id}`, {\n      method: \"PUT\",\n      body: JSON.stringify(data),\n    }),\n  \n  deleteFieldTemplate: (id: string) =>\n    fetchAPI<any>(`/api/settings/field-templates/${id}`, { method: \"DELETE\" }),\n  \n  // Channels\n  listChannels: () =>\n    fetchAPI<any[]>(\"/api/settings/channels\"),\n  \n  createChannel: (data: any) =>\n    fetchAPI<any>(\"/api/settings/channels\", {\n      method: \"POST\",\n      body: JSON.stringify(data),\n    }),\n  \n  updateChannel: (id: string, data: any) =>\n    fetchAPI<any>(`/api/settings/channels/${id}`, {\n      method: \"PUT\",\n      body: JSON.stringify(data),\n    }),\n  \n  deleteChannel: (id: string) =>\n    fetchAPI<any>(`/api/settings/channels/${id}`, { method: \"DELETE\" }),\n  \n  // Simulators\n  listSimulators: () =>\n    fetchAPI<any[]>(\"/api/settings/simulators\"),\n  \n  createSimulator: (data: any) =>\n    fetchAPI<any>(\"/api/settings/simulators\", {\n      method: \"POST\",\n      body: JSON.stringify(data),\n    }),\n  \n  updateSimulator: (id: string, data: any) =>\n    fetchAPI<any>(`/api/settings/simulators/${id}`, {\n      method: \"PUT\",\n      body: JSON.stringify(data),\n    }),\n  \n  deleteSimulator: (id: string) =>\n    fetchAPI<any>(`/api/settings/simulators/${id}`, { method: \"DELETE\" }),\n  \n  // Agent Settings\n  getAgentSettings: () =>\n    fetchAPI<any>(\"/api/settings/agent\"),\n  \n  updateAgentSettings: (data: any) =>\n    fetchAPI<any>(\"/api/settings/agent\", {\n      method: \"PUT\",\n      body: JSON.stringify(data),\n    }),\n  \n  // Logs\n  listLogs: (projectId?: string) => {\n    const query = projectId ? `?project_id=${projectId}` : \"\";\n    return fetchAPI<any[]>(`/api/settings/logs${query}`);\n  },\n  \n  exportLogs: (projectId?: string) => {\n    const query = projectId ? `?project_id=${projectId}` : \"\";\n    return fetchAPI<any>(`/api/settings/logs/export${query}`);\n  },\n};\n\n// ============== Simulation API ==============\n\nexport const simulationAPI = {\n  // 获取项目的模拟记录列表\n  list: (projectId: string) =>\n    fetchAPI<SimulationRecord[]>(`/api/simulations/project/${projectId}`),\n  \n  // 获取模拟记录详情\n  get: (id: string) =>\n    fetchAPI<SimulationRecord>(`/api/simulations/${id}`),\n  \n  // 创建模拟记录\n  create: (data: {\n    project_id: string;\n    simulator_id: string;\n    target_field_ids: string[];\n    persona: Persona;\n  }) =>\n    fetchAPI<SimulationRecord>(\"/api/simulations/\", {\n      method: \"POST\",\n      body: JSON.stringify(data),\n    }),\n  \n  // 删除模拟记录\n  delete: (id: string) =>\n    fetchAPI<any>(`/api/simulations/${id}`, { method: \"DELETE\" }),\n  \n  // 获取消费者调研中的人物小传\n  getPersonasFromResearch: (projectId: string) =>\n    fetchAPI<PersonaFromResearch[]>(`/api/simulations/project/${projectId}/personas`),\n};\n\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 939, "column": 0}, "map": {"version":3,"sources":["file:///D:/G/vibe_projects/202601_content_production_system_2/frontend/components/simulation-panel.tsx"],"sourcesContent":["// frontend/components/simulation-panel.tsx\r\n// 功能: 消费者模拟阶段专用面板\r\n// 主要组件: SimulationPanel\r\n// 包含: 人物小传选择、模拟记录表格、新建模拟\r\n\r\n\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { simulationAPI, settingsAPI } from \"@/lib/api\";\r\nimport type { SimulationRecord, PersonaFromResearch, Persona } from \"@/lib/api\";\r\n\r\ninterface SimulationPanelProps {\r\n  projectId: string;\r\n  fields: any[];\r\n  onSimulationCreated?: () => void;\r\n}\r\n\r\nexport function SimulationPanel({\r\n  projectId,\r\n  fields,\r\n  onSimulationCreated,\r\n}: SimulationPanelProps) {\r\n  const [simulations, setSimulations] = useState<SimulationRecord[]>([]);\r\n  const [personas, setPersonas] = useState<PersonaFromResearch[]>([]);\r\n  const [simulators, setSimulators] = useState<any[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [showCreateModal, setShowCreateModal] = useState(false);\r\n\r\n  useEffect(() => {\r\n    loadData();\r\n  }, [projectId]);\r\n\r\n  const loadData = async () => {\r\n    setLoading(true);\r\n    try {\r\n      const [sims, personaList, simList] = await Promise.all([\r\n        simulationAPI.list(projectId),\r\n        simulationAPI.getPersonasFromResearch(projectId),\r\n        settingsAPI.listSimulators(),\r\n      ]);\r\n      setSimulations(sims);\r\n      setPersonas(personaList);\r\n      setSimulators(simList);\r\n    } catch (err) {\r\n      console.error(\"加载模拟数据失败:\", err);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleDelete = async (id: string) => {\r\n    if (!confirm(\"确定删除此模拟记录？\")) return;\r\n    try {\r\n      await simulationAPI.delete(id);\r\n      loadData();\r\n    } catch (err) {\r\n      alert(\"删除失败\");\r\n    }\r\n  };\r\n\r\n  if (loading) {\r\n    return <div className=\"p-6 text-zinc-500\">加载中...</div>;\r\n  }\r\n\r\n  return (\r\n    <div className=\"p-6 max-w-4xl mx-auto\">\r\n      {/* 标题 */}\r\n      <div className=\"mb-8\">\r\n        <h1 className=\"text-2xl font-bold text-zinc-100\">消费者模拟</h1>\r\n        <p className=\"text-zinc-500 mt-1\">\r\n          模拟目标用户体验内容，收集反馈\r\n        </p>\r\n      </div>\r\n\r\n      {/* 人物小传选择 */}\r\n      <div className=\"mb-8\">\r\n        <div className=\"flex justify-between items-center mb-4\">\r\n          <h2 className=\"text-lg font-semibold text-zinc-200\">可用人物小传</h2>\r\n          <span className=\"text-xs text-zinc-500\">来自消费者调研</span>\r\n        </div>\r\n        \r\n        {personas.length > 0 ? (\r\n          <div className=\"grid gap-3 md:grid-cols-2\">\r\n            {personas.map((persona, idx) => (\r\n              <div\r\n                key={idx}\r\n                className=\"p-4 bg-surface-2 border border-surface-3 rounded-xl\"\r\n              >\r\n                <h3 className=\"font-medium text-zinc-200\">{persona.name}</h3>\r\n                <p className=\"text-xs text-zinc-500 mt-1\">{persona.background}</p>\r\n                <p className=\"text-sm text-zinc-400 mt-2 line-clamp-3\">\r\n                  {persona.story}\r\n                </p>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        ) : (\r\n          <div className=\"p-4 bg-surface-2 border border-surface-3 rounded-xl text-center text-zinc-500\">\r\n            <p>暂无人物小传</p>\r\n            <p className=\"text-xs mt-1\">完成消费者调研后会自动提取人物小传</p>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* 模拟记录表格 */}\r\n      <div className=\"mb-8\">\r\n        <div className=\"flex justify-between items-center mb-4\">\r\n          <h2 className=\"text-lg font-semibold text-zinc-200\">模拟记录</h2>\r\n          <button\r\n            onClick={() => setShowCreateModal(true)}\r\n            className=\"px-4 py-2 bg-brand-600 hover:bg-brand-700 rounded-lg text-sm transition-colors\"\r\n          >\r\n            + 新建模拟\r\n          </button>\r\n        </div>\r\n\r\n        {simulations.length > 0 ? (\r\n          <div className=\"overflow-x-auto\">\r\n            <table className=\"w-full text-sm\">\r\n              <thead>\r\n                <tr className=\"border-b border-surface-3\">\r\n                  <th className=\"text-left py-3 px-3 text-zinc-500\">人物</th>\r\n                  <th className=\"text-left py-3 px-3 text-zinc-500\">模拟器</th>\r\n                  <th className=\"text-left py-3 px-3 text-zinc-500\">状态</th>\r\n                  <th className=\"text-right py-3 px-3 text-zinc-500\">评分</th>\r\n                  <th className=\"text-left py-3 px-3 text-zinc-500\">时间</th>\r\n                  <th className=\"text-right py-3 px-3 text-zinc-500\">操作</th>\r\n                </tr>\r\n              </thead>\r\n              <tbody>\r\n                {simulations.map((sim) => {\r\n                  const simulator = simulators.find(s => s.id === sim.simulator_id);\r\n                  const avgScore = Object.values(sim.feedback.scores || {}).reduce(\r\n                    (a, b) => a + b, 0\r\n                  ) / (Object.keys(sim.feedback.scores || {}).length || 1);\r\n                  \r\n                  return (\r\n                    <tr key={sim.id} className=\"border-b border-surface-3/50 hover:bg-surface-2\">\r\n                      <td className=\"py-3 px-3\">\r\n                        <div className=\"font-medium text-zinc-200\">{sim.persona.name || \"未知\"}</div>\r\n                        <div className=\"text-xs text-zinc-500\">{sim.persona.source}</div>\r\n                      </td>\r\n                      <td className=\"py-3 px-3 text-zinc-300\">\r\n                        {simulator?.name || sim.simulator_id}\r\n                      </td>\r\n                      <td className=\"py-3 px-3\">\r\n                        <span className={`px-2 py-0.5 rounded text-xs ${\r\n                          sim.status === \"completed\" \r\n                            ? \"bg-green-600/20 text-green-400\"\r\n                            : sim.status === \"running\"\r\n                            ? \"bg-yellow-600/20 text-yellow-400\"\r\n                            : \"bg-zinc-600/20 text-zinc-400\"\r\n                        }`}>\r\n                          {sim.status === \"completed\" ? \"已完成\" \r\n                            : sim.status === \"running\" ? \"进行中\" \r\n                            : \"待开始\"}\r\n                        </span>\r\n                      </td>\r\n                      <td className=\"py-3 px-3 text-right\">\r\n                        {Object.keys(sim.feedback.scores || {}).length > 0 ? (\r\n                          <span className=\"text-zinc-200\">{avgScore.toFixed(1)}</span>\r\n                        ) : (\r\n                          <span className=\"text-zinc-500\">-</span>\r\n                        )}\r\n                      </td>\r\n                      <td className=\"py-3 px-3 text-zinc-400\">\r\n                        {new Date(sim.created_at).toLocaleDateString()}\r\n                      </td>\r\n                      <td className=\"py-3 px-3 text-right\">\r\n                        <button\r\n                          onClick={() => handleDelete(sim.id)}\r\n                          className=\"text-red-400 hover:text-red-300 text-sm\"\r\n                        >\r\n                          删除\r\n                        </button>\r\n                      </td>\r\n                    </tr>\r\n                  );\r\n                })}\r\n              </tbody>\r\n            </table>\r\n          </div>\r\n        ) : (\r\n          <div className=\"p-8 bg-surface-2 border border-surface-3 rounded-xl text-center text-zinc-500\">\r\n            <p>暂无模拟记录</p>\r\n            <p className=\"text-xs mt-1\">点击\"新建模拟\"开始消费者模拟</p>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* 新建模拟弹窗 */}\r\n      {showCreateModal && (\r\n        <CreateSimulationModal\r\n          projectId={projectId}\r\n          personas={personas}\r\n          simulators={simulators}\r\n          fields={fields}\r\n          onClose={() => setShowCreateModal(false)}\r\n          onCreated={() => {\r\n            setShowCreateModal(false);\r\n            loadData();\r\n            onSimulationCreated?.();\r\n          }}\r\n        />\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\ninterface CreateSimulationModalProps {\r\n  projectId: string;\r\n  personas: PersonaFromResearch[];\r\n  simulators: any[];\r\n  fields: any[];\r\n  onClose: () => void;\r\n  onCreated: () => void;\r\n}\r\n\r\nfunction CreateSimulationModal({\r\n  projectId,\r\n  personas,\r\n  simulators,\r\n  fields,\r\n  onClose,\r\n  onCreated,\r\n}: CreateSimulationModalProps) {\r\n  const [simulatorId, setSimulatorId] = useState(simulators[0]?.id || \"\");\r\n  const [personaSource, setPersonaSource] = useState<\"research\" | \"custom\">(\"research\");\r\n  const [selectedPersonaIdx, setSelectedPersonaIdx] = useState(0);\r\n  const [customPersona, setCustomPersona] = useState({ name: \"\", background: \"\", story: \"\" });\r\n  const [selectedFieldIds, setSelectedFieldIds] = useState<string[]>([]);\r\n  const [creating, setCreating] = useState(false);\r\n\r\n  // 可选的字段（已完成的内涵/外延字段）\r\n  const completedFields = fields.filter(\r\n    (f) => f.status === \"completed\" && \r\n    [\"produce_inner\", \"produce_outer\"].includes(f.phase)\r\n  );\r\n\r\n  const handleCreate = async () => {\r\n    if (!simulatorId) {\r\n      alert(\"请选择模拟器\");\r\n      return;\r\n    }\r\n\r\n    const persona: Persona = personaSource === \"research\" && personas[selectedPersonaIdx]\r\n      ? {\r\n          source: \"research\",\r\n          name: personas[selectedPersonaIdx].name,\r\n          background: personas[selectedPersonaIdx].background,\r\n          story: personas[selectedPersonaIdx].story,\r\n        }\r\n      : {\r\n          source: \"custom\",\r\n          name: customPersona.name,\r\n          background: customPersona.background,\r\n          story: customPersona.story,\r\n        };\r\n\r\n    if (!persona.name) {\r\n      alert(\"请填写人物名称\");\r\n      return;\r\n    }\r\n\r\n    setCreating(true);\r\n    try {\r\n      await simulationAPI.create({\r\n        project_id: projectId,\r\n        simulator_id: simulatorId,\r\n        target_field_ids: selectedFieldIds,\r\n        persona,\r\n      });\r\n      onCreated();\r\n    } catch (err) {\r\n      alert(\"创建失败: \" + (err instanceof Error ? err.message : \"未知错误\"));\r\n    } finally {\r\n      setCreating(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\r\n      <div className=\"bg-surface-2 rounded-xl border border-surface-3 w-full max-w-2xl max-h-[85vh] overflow-hidden\">\r\n        <div className=\"px-4 py-3 border-b border-surface-3\">\r\n          <h3 className=\"font-medium text-zinc-200\">新建消费者模拟</h3>\r\n        </div>\r\n\r\n        <div className=\"p-4 max-h-[60vh] overflow-y-auto space-y-6\">\r\n          {/* 选择模拟器 */}\r\n          <div>\r\n            <label className=\"block text-sm text-zinc-400 mb-2\">模拟器类型</label>\r\n            <select\r\n              value={simulatorId}\r\n              onChange={(e) => setSimulatorId(e.target.value)}\r\n              className=\"w-full px-3 py-2 bg-surface-1 border border-surface-3 rounded-lg text-zinc-200\"\r\n            >\r\n              {simulators.map((s) => (\r\n                <option key={s.id} value={s.id}>\r\n                  {s.name} - {s.interaction_type}\r\n                </option>\r\n              ))}\r\n            </select>\r\n          </div>\r\n\r\n          {/* 人物来源选择 */}\r\n          <div>\r\n            <label className=\"block text-sm text-zinc-400 mb-2\">人物画像来源</label>\r\n            <div className=\"flex gap-4\">\r\n              <label className=\"flex items-center gap-2 cursor-pointer\">\r\n                <input\r\n                  type=\"radio\"\r\n                  checked={personaSource === \"research\"}\r\n                  onChange={() => setPersonaSource(\"research\")}\r\n                />\r\n                <span className=\"text-zinc-200\">从消费者调研选择</span>\r\n              </label>\r\n              <label className=\"flex items-center gap-2 cursor-pointer\">\r\n                <input\r\n                  type=\"radio\"\r\n                  checked={personaSource === \"custom\"}\r\n                  onChange={() => setPersonaSource(\"custom\")}\r\n                />\r\n                <span className=\"text-zinc-200\">自定义</span>\r\n              </label>\r\n            </div>\r\n          </div>\r\n\r\n          {/* 人物选择/输入 */}\r\n          {personaSource === \"research\" ? (\r\n            <div>\r\n              <label className=\"block text-sm text-zinc-400 mb-2\">选择人物小传</label>\r\n              {personas.length > 0 ? (\r\n                <div className=\"space-y-2\">\r\n                  {personas.map((p, idx) => (\r\n                    <label\r\n                      key={idx}\r\n                      className={`flex items-start gap-3 p-3 rounded-lg cursor-pointer border ${\r\n                        selectedPersonaIdx === idx\r\n                          ? \"border-brand-500 bg-brand-600/10\"\r\n                          : \"border-surface-3 hover:bg-surface-3\"\r\n                      }`}\r\n                    >\r\n                      <input\r\n                        type=\"radio\"\r\n                        checked={selectedPersonaIdx === idx}\r\n                        onChange={() => setSelectedPersonaIdx(idx)}\r\n                        className=\"mt-1\"\r\n                      />\r\n                      <div>\r\n                        <div className=\"font-medium text-zinc-200\">{p.name}</div>\r\n                        <div className=\"text-xs text-zinc-500\">{p.background}</div>\r\n                        <div className=\"text-sm text-zinc-400 mt-1 line-clamp-2\">{p.story}</div>\r\n                      </div>\r\n                    </label>\r\n                  ))}\r\n                </div>\r\n              ) : (\r\n                <div className=\"p-4 text-center text-zinc-500 bg-surface-1 rounded-lg\">\r\n                  暂无可用的人物小传，请选择\"自定义\"\r\n                </div>\r\n              )}\r\n            </div>\r\n          ) : (\r\n            <div className=\"space-y-4\">\r\n              <div>\r\n                <label className=\"block text-sm text-zinc-400 mb-1\">人物名称</label>\r\n                <input\r\n                  type=\"text\"\r\n                  value={customPersona.name}\r\n                  onChange={(e) => setCustomPersona({ ...customPersona, name: e.target.value })}\r\n                  className=\"w-full px-3 py-2 bg-surface-1 border border-surface-3 rounded-lg text-zinc-200\"\r\n                  placeholder=\"如：张医生\"\r\n                />\r\n              </div>\r\n              <div>\r\n                <label className=\"block text-sm text-zinc-400 mb-1\">背景描述</label>\r\n                <input\r\n                  type=\"text\"\r\n                  value={customPersona.background}\r\n                  onChange={(e) => setCustomPersona({ ...customPersona, background: e.target.value })}\r\n                  className=\"w-full px-3 py-2 bg-surface-1 border border-surface-3 rounded-lg text-zinc-200\"\r\n                  placeholder=\"如：某三甲医院主任医师，从业15年\"\r\n                />\r\n              </div>\r\n              <div>\r\n                <label className=\"block text-sm text-zinc-400 mb-1\">人物小传</label>\r\n                <textarea\r\n                  value={customPersona.story}\r\n                  onChange={(e) => setCustomPersona({ ...customPersona, story: e.target.value })}\r\n                  rows={4}\r\n                  className=\"w-full px-3 py-2 bg-surface-1 border border-surface-3 rounded-lg text-zinc-200\"\r\n                  placeholder=\"详细描述人物的背景、需求、痛点等...\"\r\n                />\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {/* 选择要模拟的内容 */}\r\n          <div>\r\n            <label className=\"block text-sm text-zinc-400 mb-2\">选择要模拟的内容（可选）</label>\r\n            {completedFields.length > 0 ? (\r\n              <div className=\"space-y-2 max-h-40 overflow-y-auto\">\r\n                {completedFields.map((f) => (\r\n                  <label key={f.id} className=\"flex items-center gap-2 cursor-pointer\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      checked={selectedFieldIds.includes(f.id)}\r\n                      onChange={(e) => {\r\n                        if (e.target.checked) {\r\n                          setSelectedFieldIds([...selectedFieldIds, f.id]);\r\n                        } else {\r\n                          setSelectedFieldIds(selectedFieldIds.filter((id) => id !== f.id));\r\n                        }\r\n                      }}\r\n                    />\r\n                    <span className=\"text-zinc-200\">{f.name}</span>\r\n                    <span className=\"text-xs text-zinc-500\">({f.phase})</span>\r\n                  </label>\r\n                ))}\r\n              </div>\r\n            ) : (\r\n              <div className=\"text-sm text-zinc-500\">暂无已完成的内容字段</div>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"px-4 py-3 border-t border-surface-3 flex justify-end gap-2\">\r\n          <button\r\n            onClick={onClose}\r\n            className=\"px-4 py-2 text-sm bg-surface-3 hover:bg-surface-4 rounded-lg\"\r\n          >\r\n            取消\r\n          </button>\r\n          <button\r\n            onClick={handleCreate}\r\n            disabled={creating}\r\n            className=\"px-4 py-2 text-sm bg-brand-600 hover:bg-brand-700 rounded-lg disabled:opacity-50\"\r\n          >\r\n            {creating ? \"创建中...\" : \"创建模拟\"}\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n"],"names":[],"mappings":";;;;;AAOA;AACA;;;AARA,2CAA2C;AAC3C,kBAAkB;AAClB,wBAAwB;AACxB,yBAAyB;AAEzB;;;AAYO,SAAS,gBAAgB,EAC9B,SAAS,EACT,MAAM,EACN,mBAAmB,EACE;;IACrB,MAAM,CAAC,aAAa,eAAe,GAAG,IAAA,yKAAQ,EAAqB,EAAE;IACrE,MAAM,CAAC,UAAU,YAAY,GAAG,IAAA,yKAAQ,EAAwB,EAAE;IAClE,MAAM,CAAC,YAAY,cAAc,GAAG,IAAA,yKAAQ,EAAQ,EAAE;IACtD,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,yKAAQ,EAAC;IACvC,MAAM,CAAC,iBAAiB,mBAAmB,GAAG,IAAA,yKAAQ,EAAC;IAEvD,IAAA,0KAAS;qCAAC;YACR;QACF;oCAAG;QAAC;KAAU;IAEd,MAAM,WAAW;QACf,WAAW;QACX,IAAI;YACF,MAAM,CAAC,MAAM,aAAa,QAAQ,GAAG,MAAM,QAAQ,GAAG,CAAC;gBACrD,8HAAa,CAAC,IAAI,CAAC;gBACnB,8HAAa,CAAC,uBAAuB,CAAC;gBACtC,4HAAW,CAAC,cAAc;aAC3B;YACD,eAAe;YACf,YAAY;YACZ,cAAc;QAChB,EAAE,OAAO,KAAK;YACZ,QAAQ,KAAK,CAAC,aAAa;QAC7B,SAAU;YACR,WAAW;QACb;IACF;IAEA,MAAM,eAAe,OAAO;QAC1B,IAAI,CAAC,QAAQ,eAAe;QAC5B,IAAI;YACF,MAAM,8HAAa,CAAC,MAAM,CAAC;YAC3B;QACF,EAAE,OAAO,KAAK;YACZ,MAAM;QACR;IACF;IAEA,IAAI,SAAS;QACX,qBAAO,6LAAC;YAAI,WAAU;sBAAoB;;;;;;IAC5C;IAEA,qBACE,6LAAC;QAAI,WAAU;;0BAEb,6LAAC;gBAAI,WAAU;;kCACb,6LAAC;wBAAG,WAAU;kCAAmC;;;;;;kCACjD,6LAAC;wBAAE,WAAU;kCAAqB;;;;;;;;;;;;0BAMpC,6LAAC;gBAAI,WAAU;;kCACb,6LAAC;wBAAI,WAAU;;0CACb,6LAAC;gCAAG,WAAU;0CAAsC;;;;;;0CACpD,6LAAC;gCAAK,WAAU;0CAAwB;;;;;;;;;;;;oBAGzC,SAAS,MAAM,GAAG,kBACjB,6LAAC;wBAAI,WAAU;kCACZ,SAAS,GAAG,CAAC,CAAC,SAAS,oBACtB,6LAAC;gCAEC,WAAU;;kDAEV,6LAAC;wCAAG,WAAU;kDAA6B,QAAQ,IAAI;;;;;;kDACvD,6LAAC;wCAAE,WAAU;kDAA8B,QAAQ,UAAU;;;;;;kDAC7D,6LAAC;wCAAE,WAAU;kDACV,QAAQ,KAAK;;;;;;;+BANX;;;;;;;;;6CAYX,6LAAC;wBAAI,WAAU;;0CACb,6LAAC;0CAAE;;;;;;0CACH,6LAAC;gCAAE,WAAU;0CAAe;;;;;;;;;;;;;;;;;;0BAMlC,6LAAC;gBAAI,WAAU;;kCACb,6LAAC;wBAAI,WAAU;;0CACb,6LAAC;gCAAG,WAAU;0CAAsC;;;;;;0CACpD,6LAAC;gCACC,SAAS,IAAM,mBAAmB;gCAClC,WAAU;0CACX;;;;;;;;;;;;oBAKF,YAAY,MAAM,GAAG,kBACpB,6LAAC;wBAAI,WAAU;kCACb,cAAA,6LAAC;4BAAM,WAAU;;8CACf,6LAAC;8CACC,cAAA,6LAAC;wCAAG,WAAU;;0DACZ,6LAAC;gDAAG,WAAU;0DAAoC;;;;;;0DAClD,6LAAC;gDAAG,WAAU;0DAAoC;;;;;;0DAClD,6LAAC;gDAAG,WAAU;0DAAoC;;;;;;0DAClD,6LAAC;gDAAG,WAAU;0DAAqC;;;;;;0DACnD,6LAAC;gDAAG,WAAU;0DAAoC;;;;;;0DAClD,6LAAC;gDAAG,WAAU;0DAAqC;;;;;;;;;;;;;;;;;8CAGvD,6LAAC;8CACE,YAAY,GAAG,CAAC,CAAC;wCAChB,MAAM,YAAY,WAAW,IAAI,CAAC,CAAA,IAAK,EAAE,EAAE,KAAK,IAAI,YAAY;wCAChE,MAAM,WAAW,OAAO,MAAM,CAAC,IAAI,QAAQ,CAAC,MAAM,IAAI,CAAC,GAAG,MAAM,CAC9D,CAAC,GAAG,IAAM,IAAI,GAAG,KACf,CAAC,OAAO,IAAI,CAAC,IAAI,QAAQ,CAAC,MAAM,IAAI,CAAC,GAAG,MAAM,IAAI,CAAC;wCAEvD,qBACE,6LAAC;4CAAgB,WAAU;;8DACzB,6LAAC;oDAAG,WAAU;;sEACZ,6LAAC;4DAAI,WAAU;sEAA6B,IAAI,OAAO,CAAC,IAAI,IAAI;;;;;;sEAChE,6LAAC;4DAAI,WAAU;sEAAyB,IAAI,OAAO,CAAC,MAAM;;;;;;;;;;;;8DAE5D,6LAAC;oDAAG,WAAU;8DACX,WAAW,QAAQ,IAAI,YAAY;;;;;;8DAEtC,6LAAC;oDAAG,WAAU;8DACZ,cAAA,6LAAC;wDAAK,WAAW,CAAC,4BAA4B,EAC5C,IAAI,MAAM,KAAK,cACX,mCACA,IAAI,MAAM,KAAK,YACf,qCACA,gCACJ;kEACC,IAAI,MAAM,KAAK,cAAc,QAC1B,IAAI,MAAM,KAAK,YAAY,QAC3B;;;;;;;;;;;8DAGR,6LAAC;oDAAG,WAAU;8DACX,OAAO,IAAI,CAAC,IAAI,QAAQ,CAAC,MAAM,IAAI,CAAC,GAAG,MAAM,GAAG,kBAC/C,6LAAC;wDAAK,WAAU;kEAAiB,SAAS,OAAO,CAAC;;;;;6EAElD,6LAAC;wDAAK,WAAU;kEAAgB;;;;;;;;;;;8DAGpC,6LAAC;oDAAG,WAAU;8DACX,IAAI,KAAK,IAAI,UAAU,EAAE,kBAAkB;;;;;;8DAE9C,6LAAC;oDAAG,WAAU;8DACZ,cAAA,6LAAC;wDACC,SAAS,IAAM,aAAa,IAAI,EAAE;wDAClC,WAAU;kEACX;;;;;;;;;;;;2CAnCI,IAAI,EAAE;;;;;oCAyCnB;;;;;;;;;;;;;;;;6CAKN,6LAAC;wBAAI,WAAU;;0CACb,6LAAC;0CAAE;;;;;;0CACH,6LAAC;gCAAE,WAAU;0CAAe;;;;;;;;;;;;;;;;;;YAMjC,iCACC,6LAAC;gBACC,WAAW;gBACX,UAAU;gBACV,YAAY;gBACZ,QAAQ;gBACR,SAAS,IAAM,mBAAmB;gBAClC,WAAW;oBACT,mBAAmB;oBACnB;oBACA;gBACF;;;;;;;;;;;;AAKV;GA9LgB;KAAA;AAyMhB,SAAS,sBAAsB,EAC7B,SAAS,EACT,QAAQ,EACR,UAAU,EACV,MAAM,EACN,OAAO,EACP,SAAS,EACkB;;IAC3B,MAAM,CAAC,aAAa,eAAe,GAAG,IAAA,yKAAQ,EAAC,UAAU,CAAC,EAAE,EAAE,MAAM;IACpE,MAAM,CAAC,eAAe,iBAAiB,GAAG,IAAA,yKAAQ,EAAwB;IAC1E,MAAM,CAAC,oBAAoB,sBAAsB,GAAG,IAAA,yKAAQ,EAAC;IAC7D,MAAM,CAAC,eAAe,iBAAiB,GAAG,IAAA,yKAAQ,EAAC;QAAE,MAAM;QAAI,YAAY;QAAI,OAAO;IAAG;IACzF,MAAM,CAAC,kBAAkB,oBAAoB,GAAG,IAAA,yKAAQ,EAAW,EAAE;IACrE,MAAM,CAAC,UAAU,YAAY,GAAG,IAAA,yKAAQ,EAAC;IAEzC,qBAAqB;IACrB,MAAM,kBAAkB,OAAO,MAAM,CACnC,CAAC,IAAM,EAAE,MAAM,KAAK,eACpB;YAAC;YAAiB;SAAgB,CAAC,QAAQ,CAAC,EAAE,KAAK;IAGrD,MAAM,eAAe;QACnB,IAAI,CAAC,aAAa;YAChB,MAAM;YACN;QACF;QAEA,MAAM,UAAmB,kBAAkB,cAAc,QAAQ,CAAC,mBAAmB,GACjF;YACE,QAAQ;YACR,MAAM,QAAQ,CAAC,mBAAmB,CAAC,IAAI;YACvC,YAAY,QAAQ,CAAC,mBAAmB,CAAC,UAAU;YACnD,OAAO,QAAQ,CAAC,mBAAmB,CAAC,KAAK;QAC3C,IACA;YACE,QAAQ;YACR,MAAM,cAAc,IAAI;YACxB,YAAY,cAAc,UAAU;YACpC,OAAO,cAAc,KAAK;QAC5B;QAEJ,IAAI,CAAC,QAAQ,IAAI,EAAE;YACjB,MAAM;YACN;QACF;QAEA,YAAY;QACZ,IAAI;YACF,MAAM,8HAAa,CAAC,MAAM,CAAC;gBACzB,YAAY;gBACZ,cAAc;gBACd,kBAAkB;gBAClB;YACF;YACA;QACF,EAAE,OAAO,KAAK;YACZ,MAAM,WAAW,CAAC,eAAe,QAAQ,IAAI,OAAO,GAAG,MAAM;QAC/D,SAAU;YACR,YAAY;QACd;IACF;IAEA,qBACE,6LAAC;QAAI,WAAU;kBACb,cAAA,6LAAC;YAAI,WAAU;;8BACb,6LAAC;oBAAI,WAAU;8BACb,cAAA,6LAAC;wBAAG,WAAU;kCAA4B;;;;;;;;;;;8BAG5C,6LAAC;oBAAI,WAAU;;sCAEb,6LAAC;;8CACC,6LAAC;oCAAM,WAAU;8CAAmC;;;;;;8CACpD,6LAAC;oCACC,OAAO;oCACP,UAAU,CAAC,IAAM,eAAe,EAAE,MAAM,CAAC,KAAK;oCAC9C,WAAU;8CAET,WAAW,GAAG,CAAC,CAAC,kBACf,6LAAC;4CAAkB,OAAO,EAAE,EAAE;;gDAC3B,EAAE,IAAI;gDAAC;gDAAI,EAAE,gBAAgB;;2CADnB,EAAE,EAAE;;;;;;;;;;;;;;;;sCAQvB,6LAAC;;8CACC,6LAAC;oCAAM,WAAU;8CAAmC;;;;;;8CACpD,6LAAC;oCAAI,WAAU;;sDACb,6LAAC;4CAAM,WAAU;;8DACf,6LAAC;oDACC,MAAK;oDACL,SAAS,kBAAkB;oDAC3B,UAAU,IAAM,iBAAiB;;;;;;8DAEnC,6LAAC;oDAAK,WAAU;8DAAgB;;;;;;;;;;;;sDAElC,6LAAC;4CAAM,WAAU;;8DACf,6LAAC;oDACC,MAAK;oDACL,SAAS,kBAAkB;oDAC3B,UAAU,IAAM,iBAAiB;;;;;;8DAEnC,6LAAC;oDAAK,WAAU;8DAAgB;;;;;;;;;;;;;;;;;;;;;;;;wBAMrC,kBAAkB,2BACjB,6LAAC;;8CACC,6LAAC;oCAAM,WAAU;8CAAmC;;;;;;gCACnD,SAAS,MAAM,GAAG,kBACjB,6LAAC;oCAAI,WAAU;8CACZ,SAAS,GAAG,CAAC,CAAC,GAAG,oBAChB,6LAAC;4CAEC,WAAW,CAAC,4DAA4D,EACtE,uBAAuB,MACnB,qCACA,uCACJ;;8DAEF,6LAAC;oDACC,MAAK;oDACL,SAAS,uBAAuB;oDAChC,UAAU,IAAM,sBAAsB;oDACtC,WAAU;;;;;;8DAEZ,6LAAC;;sEACC,6LAAC;4DAAI,WAAU;sEAA6B,EAAE,IAAI;;;;;;sEAClD,6LAAC;4DAAI,WAAU;sEAAyB,EAAE,UAAU;;;;;;sEACpD,6LAAC;4DAAI,WAAU;sEAA2C,EAAE,KAAK;;;;;;;;;;;;;2CAhB9D;;;;;;;;;yDAsBX,6LAAC;oCAAI,WAAU;8CAAwD;;;;;;;;;;;iDAM3E,6LAAC;4BAAI,WAAU;;8CACb,6LAAC;;sDACC,6LAAC;4CAAM,WAAU;sDAAmC;;;;;;sDACpD,6LAAC;4CACC,MAAK;4CACL,OAAO,cAAc,IAAI;4CACzB,UAAU,CAAC,IAAM,iBAAiB;oDAAE,GAAG,aAAa;oDAAE,MAAM,EAAE,MAAM,CAAC,KAAK;gDAAC;4CAC3E,WAAU;4CACV,aAAY;;;;;;;;;;;;8CAGhB,6LAAC;;sDACC,6LAAC;4CAAM,WAAU;sDAAmC;;;;;;sDACpD,6LAAC;4CACC,MAAK;4CACL,OAAO,cAAc,UAAU;4CAC/B,UAAU,CAAC,IAAM,iBAAiB;oDAAE,GAAG,aAAa;oDAAE,YAAY,EAAE,MAAM,CAAC,KAAK;gDAAC;4CACjF,WAAU;4CACV,aAAY;;;;;;;;;;;;8CAGhB,6LAAC;;sDACC,6LAAC;4CAAM,WAAU;sDAAmC;;;;;;sDACpD,6LAAC;4CACC,OAAO,cAAc,KAAK;4CAC1B,UAAU,CAAC,IAAM,iBAAiB;oDAAE,GAAG,aAAa;oDAAE,OAAO,EAAE,MAAM,CAAC,KAAK;gDAAC;4CAC5E,MAAM;4CACN,WAAU;4CACV,aAAY;;;;;;;;;;;;;;;;;;sCAOpB,6LAAC;;8CACC,6LAAC;oCAAM,WAAU;8CAAmC;;;;;;gCACnD,gBAAgB,MAAM,GAAG,kBACxB,6LAAC;oCAAI,WAAU;8CACZ,gBAAgB,GAAG,CAAC,CAAC,kBACpB,6LAAC;4CAAiB,WAAU;;8DAC1B,6LAAC;oDACC,MAAK;oDACL,SAAS,iBAAiB,QAAQ,CAAC,EAAE,EAAE;oDACvC,UAAU,CAAC;wDACT,IAAI,EAAE,MAAM,CAAC,OAAO,EAAE;4DACpB,oBAAoB;mEAAI;gEAAkB,EAAE,EAAE;6DAAC;wDACjD,OAAO;4DACL,oBAAoB,iBAAiB,MAAM,CAAC,CAAC,KAAO,OAAO,EAAE,EAAE;wDACjE;oDACF;;;;;;8DAEF,6LAAC;oDAAK,WAAU;8DAAiB,EAAE,IAAI;;;;;;8DACvC,6LAAC;oDAAK,WAAU;;wDAAwB;wDAAE,EAAE,KAAK;wDAAC;;;;;;;;2CAbxC,EAAE,EAAE;;;;;;;;;yDAkBpB,6LAAC;oCAAI,WAAU;8CAAwB;;;;;;;;;;;;;;;;;;8BAK7C,6LAAC;oBAAI,WAAU;;sCACb,6LAAC;4BACC,SAAS;4BACT,WAAU;sCACX;;;;;;sCAGD,6LAAC;4BACC,SAAS;4BACT,UAAU;4BACV,WAAU;sCAET,WAAW,WAAW;;;;;;;;;;;;;;;;;;;;;;;AAMnC;IAlOS;MAAA"}},
    {"offset": {"line": 1908, "column": 0}, "map": {"version":3,"sources":["file:///D:/G/vibe_projects/202601_content_production_system_2/frontend/components/content-panel.tsx"],"sourcesContent":["// frontend/components/content-panel.tsx\n// 功能: 中栏内容展示面板，支持字段依赖选择和生成\n// 主要组件: ContentPanel, FieldCard\n// 新增: 依赖选择弹窗、生成按钮、依赖状态显示、模拟阶段特殊面板\n\n\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport { PHASE_NAMES } from \"@/lib/utils\";\nimport { fieldAPI } from \"@/lib/api\";\nimport type { Field } from \"@/lib/api\";\nimport { SimulationPanel } from \"./simulation-panel\";\n\ninterface ContentPanelProps {\n  projectId: string | null;\n  currentPhase: string;\n  fields: Field[];\n  onFieldUpdate?: (fieldId: string, content: string) => void;\n  onFieldsChange?: () => void;\n}\n\nexport function ContentPanel({\n  projectId,\n  currentPhase,\n  fields,\n  onFieldUpdate,\n  onFieldsChange,\n}: ContentPanelProps) {\n  const phaseFields = fields.filter((f) => f.phase === currentPhase);\n  const allCompletedFields = fields.filter((f) => f.status === \"completed\");\n\n  if (!projectId) {\n    return (\n      <div className=\"flex items-center justify-center h-full text-zinc-500\">\n        <div className=\"text-center\">\n          <p className=\"text-lg mb-2\">请选择或创建一个项目</p>\n          <p className=\"text-sm\">在左侧选择项目开始工作</p>\n        </div>\n      </div>\n    );\n  }\n\n  // 消费者模拟阶段使用专用面板\n  if (currentPhase === \"simulate\") {\n    return (\n      <SimulationPanel\n        projectId={projectId}\n        fields={fields}\n        onSimulationCreated={onFieldsChange}\n      />\n    );\n  }\n\n  return (\n    <div className=\"p-6 max-w-4xl mx-auto\">\n      {/* 阶段标题 */}\n      <div className=\"mb-8\">\n        <h1 className=\"text-2xl font-bold text-zinc-100\">\n          {PHASE_NAMES[currentPhase] || currentPhase}\n        </h1>\n        <p className=\"text-zinc-500 mt-1\">\n          {getPhaseDescription(currentPhase)}\n        </p>\n      </div>\n\n      {/* 字段列表 */}\n      {phaseFields.length > 0 ? (\n        <div className=\"space-y-6\">\n          {phaseFields.map((field) => (\n            <FieldCard\n              key={field.id}\n              field={field}\n              allFields={fields}\n              onUpdate={(content) => onFieldUpdate?.(field.id, content)}\n              onFieldsChange={onFieldsChange}\n            />\n          ))}\n        </div>\n      ) : (\n        <div className=\"text-center py-12 text-zinc-500\">\n          <p>当前阶段暂无内容</p>\n          <p className=\"text-sm mt-2\">\n            在右侧与 AI Agent 对话开始生产内容\n          </p>\n        </div>\n      )}\n    </div>\n  );\n}\n\ninterface FieldCardProps {\n  field: Field;\n  allFields: Field[];\n  onUpdate?: (content: string) => void;\n  onFieldsChange?: () => void;\n}\n\nfunction FieldCard({ field, allFields, onUpdate, onFieldsChange }: FieldCardProps) {\n  const [isEditing, setIsEditing] = useState(false);\n  const [content, setContent] = useState(field.content);\n  const [showDependencyModal, setShowDependencyModal] = useState(false);\n  const [isGenerating, setIsGenerating] = useState(false);\n  const [generatingContent, setGeneratingContent] = useState(\"\");\n\n  useEffect(() => {\n    setContent(field.content);\n  }, [field.content]);\n\n  // 获取依赖字段信息\n  const dependsOnIds = field.dependencies?.depends_on || [];\n  const dependencyFields = allFields.filter((f) => dependsOnIds.includes(f.id));\n  const unmetDependencies = dependencyFields.filter((f) => f.status !== \"completed\");\n  const canGenerate = unmetDependencies.length === 0;\n\n  const handleSave = () => {\n    onUpdate?.(content);\n    setIsEditing(false);\n  };\n\n  const handleGenerate = async () => {\n    if (!canGenerate) {\n      alert(`请先完成依赖字段: ${unmetDependencies.map(f => f.name).join(\", \")}`);\n      return;\n    }\n\n    setIsGenerating(true);\n    setGeneratingContent(\"\");\n\n    try {\n      // 使用流式生成\n      const response = await fetch(`http://localhost:8000/api/fields/${field.id}/generate/stream`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ pre_answers: field.pre_answers || {} }),\n      });\n\n      const reader = response.body?.getReader();\n      const decoder = new TextDecoder();\n\n      if (reader) {\n        while (true) {\n          const { done, value } = await reader.read();\n          if (done) break;\n\n          const text = decoder.decode(value);\n          const lines = text.split(\"\\n\");\n\n          for (const line of lines) {\n            if (line.startsWith(\"data: \")) {\n              try {\n                const data = JSON.parse(line.slice(6));\n                if (data.chunk) {\n                  setGeneratingContent((prev) => prev + data.chunk);\n                }\n                if (data.done) {\n                  onFieldsChange?.();\n                }\n              } catch {}\n            }\n          }\n        }\n      }\n    } catch (err) {\n      console.error(\"生成失败:\", err);\n      alert(\"生成失败: \" + (err instanceof Error ? err.message : \"未知错误\"));\n    } finally {\n      setIsGenerating(false);\n    }\n  };\n\n  const handleUpdateDependencies = async (newDependsOn: string[]) => {\n    try {\n      await fieldAPI.update(field.id, {\n        dependencies: {\n          depends_on: newDependsOn,\n          dependency_type: field.dependencies?.dependency_type || \"all\",\n        },\n      });\n      onFieldsChange?.();\n      setShowDependencyModal(false);\n    } catch (err) {\n      alert(\"更新依赖失败: \" + (err instanceof Error ? err.message : \"未知错误\"));\n    }\n  };\n\n  return (\n    <div className=\"bg-surface-2 rounded-xl border border-surface-3 overflow-hidden\">\n      {/* 字段头部 */}\n      <div className=\"px-4 py-3 border-b border-surface-3\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h3 className=\"font-medium text-zinc-200\">{field.name}</h3>\n            <div className=\"flex items-center gap-2 mt-1\">\n              <span className={`text-xs px-2 py-0.5 rounded ${\n                field.status === \"completed\" \n                  ? \"bg-green-600/20 text-green-400\"\n                  : field.status === \"generating\"\n                  ? \"bg-yellow-600/20 text-yellow-400\"\n                  : \"bg-zinc-600/20 text-zinc-400\"\n              }`}>\n                {field.status === \"completed\" ? \"已生成\" \n                  : field.status === \"generating\" ? \"生成中...\" \n                  : \"待生成\"}\n              </span>\n            </div>\n          </div>\n          \n          <div className=\"flex gap-2\">\n            {field.status !== \"completed\" && !isGenerating && (\n              <button\n                onClick={handleGenerate}\n                disabled={!canGenerate}\n                className={`px-3 py-1 text-sm rounded-lg transition-colors ${\n                  canGenerate\n                    ? \"bg-brand-600 hover:bg-brand-700 text-white\"\n                    : \"bg-zinc-700 text-zinc-500 cursor-not-allowed\"\n                }`}\n                title={canGenerate ? \"生成内容\" : `依赖未满足: ${unmetDependencies.map(f => f.name).join(\", \")}`}\n              >\n                生成\n              </button>\n            )}\n            \n            {isEditing ? (\n              <>\n                <button\n                  onClick={handleSave}\n                  className=\"px-3 py-1 text-sm bg-brand-600 hover:bg-brand-700 rounded-lg transition-colors\"\n                >\n                  保存\n                </button>\n                <button\n                  onClick={() => {\n                    setContent(field.content);\n                    setIsEditing(false);\n                  }}\n                  className=\"px-3 py-1 text-sm bg-surface-3 hover:bg-surface-4 rounded-lg transition-colors\"\n                >\n                  取消\n                </button>\n              </>\n            ) : (\n              <button\n                onClick={() => setIsEditing(true)}\n                className=\"px-3 py-1 text-sm bg-surface-3 hover:bg-surface-4 rounded-lg transition-colors\"\n              >\n                编辑\n              </button>\n            )}\n          </div>\n        </div>\n\n        {/* 依赖关系显示 */}\n        <div className=\"mt-2 flex items-center gap-2 flex-wrap\">\n          <button\n            onClick={() => setShowDependencyModal(true)}\n            className=\"text-xs text-zinc-500 hover:text-zinc-300 flex items-center gap-1\"\n          >\n            <span>📎 依赖:</span>\n            {dependencyFields.length > 0 ? (\n              dependencyFields.map((df) => (\n                <span\n                  key={df.id}\n                  className={`px-1.5 py-0.5 rounded text-xs ${\n                    df.status === \"completed\"\n                      ? \"bg-green-600/20 text-green-400\"\n                      : \"bg-red-600/20 text-red-400\"\n                  }`}\n                >\n                  {df.name}\n                </span>\n              ))\n            ) : (\n              <span className=\"text-zinc-600\">无</span>\n            )}\n            <span className=\"text-zinc-600 ml-1\">（点击编辑）</span>\n          </button>\n        </div>\n      </div>\n\n      {/* 字段内容 */}\n      <div className=\"p-4\">\n        {isGenerating ? (\n          <div className=\"bg-surface-1 border border-surface-3 rounded-lg p-3\">\n            <div className=\"text-xs text-brand-400 mb-2\">正在生成...</div>\n            <div className=\"whitespace-pre-wrap text-zinc-300 animate-pulse\">\n              {generatingContent || \"⏳ 准备中...\"}\n            </div>\n          </div>\n        ) : isEditing ? (\n          <textarea\n            value={content}\n            onChange={(e) => setContent(e.target.value)}\n            className=\"w-full min-h-[200px] bg-surface-1 border border-surface-3 rounded-lg p-3 text-zinc-200 resize-y focus:outline-none focus:ring-2 focus:ring-brand-500\"\n          />\n        ) : (\n          <div className=\"prose prose-invert max-w-none\">\n            {field.content ? (\n              <div className=\"whitespace-pre-wrap text-zinc-300\">\n                {field.content}\n              </div>\n            ) : (\n              <p className=\"text-zinc-500 italic\">暂无内容，点击\"生成\"按钮开始</p>\n            )}\n          </div>\n        )}\n      </div>\n\n      {/* 依赖选择弹窗 */}\n      {showDependencyModal && (\n        <DependencyModal\n          field={field}\n          allFields={allFields}\n          onClose={() => setShowDependencyModal(false)}\n          onSave={handleUpdateDependencies}\n        />\n      )}\n    </div>\n  );\n}\n\ninterface DependencyModalProps {\n  field: Field;\n  allFields: Field[];\n  onClose: () => void;\n  onSave: (dependsOn: string[]) => void;\n}\n\nfunction DependencyModal({ field, allFields, onClose, onSave }: DependencyModalProps) {\n  const [selectedIds, setSelectedIds] = useState<string[]>(\n    field.dependencies?.depends_on || []\n  );\n\n  // 可选的依赖字段（排除自己）\n  const availableFields = allFields.filter((f) => f.id !== field.id);\n\n  const toggleField = (id: string) => {\n    setSelectedIds((prev) =>\n      prev.includes(id) ? prev.filter((x) => x !== id) : [...prev, id]\n    );\n  };\n\n  return (\n    <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\n      <div className=\"bg-surface-2 rounded-xl border border-surface-3 w-full max-w-lg max-h-[80vh] overflow-hidden\">\n        <div className=\"px-4 py-3 border-b border-surface-3\">\n          <h3 className=\"font-medium text-zinc-200\">设置依赖关系</h3>\n          <p className=\"text-xs text-zinc-500 mt-1\">\n            选择生成\"{field.name}\"前需要先完成的字段\n          </p>\n        </div>\n\n        <div className=\"p-4 max-h-[50vh] overflow-y-auto space-y-2\">\n          {availableFields.length > 0 ? (\n            availableFields.map((f) => (\n              <label\n                key={f.id}\n                className=\"flex items-center gap-3 p-2 rounded-lg hover:bg-surface-3 cursor-pointer\"\n              >\n                <input\n                  type=\"checkbox\"\n                  checked={selectedIds.includes(f.id)}\n                  onChange={() => toggleField(f.id)}\n                  className=\"rounded\"\n                />\n                <div className=\"flex-1\">\n                  <div className=\"text-sm text-zinc-200\">{f.name}</div>\n                  <div className=\"text-xs text-zinc-500\">\n                    {f.phase} · {f.status === \"completed\" ? \"已完成\" : \"未完成\"}\n                  </div>\n                </div>\n                <span\n                  className={`w-2 h-2 rounded-full ${\n                    f.status === \"completed\" ? \"bg-green-500\" : \"bg-zinc-600\"\n                  }`}\n                />\n              </label>\n            ))\n          ) : (\n            <p className=\"text-zinc-500 text-center py-4\">暂无可选的依赖字段</p>\n          )}\n        </div>\n\n        <div className=\"px-4 py-3 border-t border-surface-3 flex justify-end gap-2\">\n          <button\n            onClick={onClose}\n            className=\"px-4 py-2 text-sm bg-surface-3 hover:bg-surface-4 rounded-lg transition-colors\"\n          >\n            取消\n          </button>\n          <button\n            onClick={() => onSave(selectedIds)}\n            className=\"px-4 py-2 text-sm bg-brand-600 hover:bg-brand-700 rounded-lg transition-colors\"\n          >\n            保存\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction getPhaseDescription(phase: string): string {\n  const descriptions: Record<string, string> = {\n    intent: \"澄清内容生产的核心意图和目标\",\n    research: \"调研目标用户，了解痛点和需求\",\n    design_inner: \"设计内容生产方案和大纲\",\n    produce_inner: \"生产核心内容\",\n    design_outer: \"设计外延传播方案\",\n    produce_outer: \"为各渠道生产营销内容\",\n    simulate: \"模拟用户体验，收集反馈\",\n    evaluate: \"全面评估内容质量\",\n  };\n  return descriptions[phase] || \"\";\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2549, "column": 0}, "map": {"version":3,"sources":["file:///D:/G/vibe_projects/202601_content_production_system_2/frontend/components/agent-panel.tsx"],"sourcesContent":["// frontend/components/agent-panel.tsx\n// 功能: 右栏AI Agent对话面板\n// 主要组件: AgentPanel, MessageBubble, MentionDropdown, ToolSelector\n// 支持: @引用、对话历史加载、编辑重发、再试一次、一键复制、Tool调用\n\n\"use client\";\n\nimport { useState, useRef, useEffect, useCallback } from \"react\";\nimport { cn, PHASE_NAMES } from \"@/lib/utils\";\nimport { agentAPI } from \"@/lib/api\";\nimport type { Field, ChatMessageRecord } from \"@/lib/api\";\n\ninterface AgentPanelProps {\n  projectId: string | null;\n  fields?: Field[];\n  onSendMessage?: (message: string) => Promise<string>;\n  onContentUpdate?: () => void;  // 当Agent生成内容后刷新\n  isLoading?: boolean;\n}\n\n// 可用的Tool列表\nconst AVAILABLE_TOOLS = [\n  { id: \"deep_research\", name: \"深度调研\", desc: \"使用DeepResearch进行网络调研\" },\n  { id: \"generate_field\", name: \"生成字段\", desc: \"根据上下文生成指定字段内容\" },\n  { id: \"simulate_consumer\", name: \"消费者模拟\", desc: \"模拟消费者体验内容\" },\n  { id: \"evaluate_content\", name: \"内容评估\", desc: \"评估内容质量\" },\n];\n\nexport function AgentPanel({\n  projectId,\n  fields = [],\n  onSendMessage,\n  onContentUpdate,\n  isLoading = false,\n}: AgentPanelProps) {\n  const [messages, setMessages] = useState<ChatMessageRecord[]>([]);\n  const [input, setInput] = useState(\"\");\n  const [sending, setSending] = useState(false);\n  const [showMentions, setShowMentions] = useState(false);\n  const [showTools, setShowTools] = useState(false);\n  const [mentionFilter, setMentionFilter] = useState(\"\");\n  const [mentionIndex, setMentionIndex] = useState(0);\n  const [cursorPosition, setCursorPosition] = useState(0);\n  const [editingMessageId, setEditingMessageId] = useState<string | null>(null);\n  const [editContent, setEditContent] = useState(\"\");\n\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n  const inputRef = useRef<HTMLInputElement>(null);\n  const mentionStartPos = useRef<number>(-1);\n\n  const completedFields = fields.filter((f) => f.status === \"completed\");\n  const filteredFields = completedFields.filter((f) =>\n    f.name.toLowerCase().includes(mentionFilter.toLowerCase()) ||\n    f.phase.toLowerCase().includes(mentionFilter.toLowerCase())\n  );\n\n  // 加载对话历史\n  useEffect(() => {\n    if (projectId) {\n      loadHistory();\n    } else {\n      setMessages([]);\n    }\n  }, [projectId]);\n\n  // 自动滚动\n  useEffect(() => {\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n  }, [messages]);\n\n  const loadHistory = async () => {\n    if (!projectId) return;\n    try {\n      const history = await agentAPI.getHistory(projectId);\n      setMessages(history);\n    } catch (err) {\n      console.error(\"加载对话历史失败:\", err);\n    }\n  };\n\n  const insertMention = useCallback((field: Field) => {\n    const beforeMention = input.slice(0, mentionStartPos.current);\n    const afterMention = input.slice(cursorPosition);\n    const newInput = `${beforeMention}@${field.name}${afterMention}`;\n    setInput(newInput);\n    setShowMentions(false);\n    setMentionFilter(\"\");\n    mentionStartPos.current = -1;\n    setTimeout(() => inputRef.current?.focus(), 0);\n  }, [input, cursorPosition]);\n\n  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const value = e.target.value;\n    const selectionStart = e.target.selectionStart || 0;\n    setInput(value);\n    setCursorPosition(selectionStart);\n\n    const lastAtPos = value.lastIndexOf(\"@\", selectionStart - 1);\n    if (lastAtPos !== -1) {\n      const textAfterAt = value.slice(lastAtPos + 1, selectionStart);\n      if (!textAfterAt.includes(\" \")) {\n        mentionStartPos.current = lastAtPos;\n        setMentionFilter(textAfterAt);\n        setShowMentions(true);\n        setMentionIndex(0);\n        return;\n      }\n    }\n    setShowMentions(false);\n    setMentionFilter(\"\");\n  };\n\n  const handleKeyDown = (e: React.KeyboardEvent) => {\n    if (showMentions && filteredFields.length > 0) {\n      if (e.key === \"ArrowDown\") {\n        e.preventDefault();\n        setMentionIndex((prev) => (prev + 1) % filteredFields.length);\n        return;\n      }\n      if (e.key === \"ArrowUp\") {\n        e.preventDefault();\n        setMentionIndex((prev) => (prev - 1 + filteredFields.length) % filteredFields.length);\n        return;\n      }\n      if (e.key === \"Enter\" || e.key === \"Tab\") {\n        e.preventDefault();\n        insertMention(filteredFields[mentionIndex]);\n        return;\n      }\n      if (e.key === \"Escape\") {\n        setShowMentions(false);\n        return;\n      }\n    }\n\n    if (e.key === \"Enter\" && !e.shiftKey && !showMentions) {\n      e.preventDefault();\n      handleSend();\n    }\n  };\n\n  const handleSend = async () => {\n    if (!input.trim() || !projectId || sending) return;\n\n    const userMessage = input.trim();\n    setInput(\"\");\n    setSending(true);\n    setShowMentions(false);\n\n    // 立即显示用户消息（乐观更新）\n    const tempUserMsg: ChatMessageRecord = {\n      id: `temp-${Date.now()}`,\n      role: \"user\",\n      content: userMessage,\n      original_content: userMessage,\n      is_edited: false,\n      metadata: {},\n      created_at: new Date().toISOString(),\n    };\n    setMessages((prev) => [...prev, tempUserMsg]);\n\n    try {\n      const response = await agentAPI.chat(projectId, userMessage);\n      // 重新加载完整历史（包含真实的消息ID和Agent响应）\n      await loadHistory();\n      \n      // 通知父组件刷新内容和进度\n      if (onContentUpdate) {\n        onContentUpdate();\n      }\n    } catch (error) {\n      console.error(\"发送失败:\", error);\n      // 移除临时消息，显示错误\n      setMessages((prev) => prev.filter((m) => m.id !== tempUserMsg.id));\n    } finally {\n      setSending(false);\n    }\n  };\n\n  const handleRetry = async (messageId: string) => {\n    if (!projectId) return;\n    setSending(true);\n    try {\n      await agentAPI.retryMessage(messageId);\n      await loadHistory();\n    } catch (err) {\n      console.error(\"重试失败:\", err);\n    } finally {\n      setSending(false);\n    }\n  };\n\n  const handleEdit = (message: ChatMessageRecord) => {\n    setEditingMessageId(message.id);\n    setEditContent(message.content);\n  };\n\n  const handleSaveEdit = async () => {\n    if (!editingMessageId || !projectId || sending) return;\n\n    setSending(true);  // 添加loading状态\n    setEditingMessageId(null);  // 立即关闭编辑框\n    \n    try {\n      await agentAPI.editMessage(editingMessageId, editContent);\n      // 编辑后重新发送\n      const response = await agentAPI.chat(projectId, editContent);\n      await loadHistory();\n      \n      // 通知父组件刷新\n      if (onContentUpdate) {\n        onContentUpdate();\n      }\n    } catch (err) {\n      console.error(\"编辑失败:\", err);\n    } finally {\n      setSending(false);\n      setEditContent(\"\");\n    }\n  };\n\n  const handleCopy = async (content: string) => {\n    try {\n      await navigator.clipboard.writeText(content);\n      // 可以添加toast提示\n    } catch (err) {\n      console.error(\"复制失败:\", err);\n    }\n  };\n\n  const handleToolCall = async (toolId: string) => {\n    if (!projectId) return;\n    setShowTools(false);\n    setSending(true);\n\n    try {\n      await agentAPI.callTool(projectId, toolId, {});\n      await loadHistory();\n    } catch (err) {\n      console.error(\"Tool调用失败:\", err);\n    } finally {\n      setSending(false);\n    }\n  };\n\n  return (\n    <div className=\"flex flex-col h-full\">\n      {/* 头部 */}\n      <div className=\"px-4 py-3 border-b border-surface-3\">\n        <h2 className=\"font-semibold text-zinc-100\">AI Agent</h2>\n        <p className=\"text-xs text-zinc-500\">\n          {projectId ? \"与 Agent 对话推进内容生产\" : \"请先选择项目\"}\n        </p>\n      </div>\n\n      {/* 消息列表 */}\n      <div className=\"flex-1 overflow-y-auto p-4 space-y-4\">\n        {messages.length === 0 && (\n          <div className=\"text-center text-zinc-500 py-8\">\n            <p>开始对话吧！</p>\n            <p className=\"text-sm mt-2\">\n              你可以说 \"开始\" 来启动内容生产流程\n            </p>\n          </div>\n        )}\n\n        {messages.map((msg) => (\n          <MessageBubble\n            key={msg.id}\n            message={msg}\n            isEditing={editingMessageId === msg.id}\n            editContent={editContent}\n            onEditContentChange={setEditContent}\n            onEdit={() => handleEdit(msg)}\n            onSaveEdit={handleSaveEdit}\n            onCancelEdit={() => setEditingMessageId(null)}\n            onRetry={() => handleRetry(msg.id)}\n            onCopy={() => handleCopy(msg.content)}\n          />\n        ))}\n\n        {sending && (\n          <div className=\"flex items-center gap-2 text-zinc-500\">\n            <div className=\"w-2 h-2 bg-brand-500 rounded-full animate-pulse\" />\n            <span className=\"text-sm\">Agent 正在思考...</span>\n          </div>\n        )}\n\n        <div ref={messagesEndRef} />\n      </div>\n\n      {/* 输入区 */}\n      <div className=\"p-4 border-t border-surface-3\">\n        <div className=\"relative\">\n          {/* @引用下拉菜单 */}\n          {showMentions && filteredFields.length > 0 && (\n            <div className=\"absolute bottom-full left-0 right-0 mb-1 bg-surface-2 border border-surface-3 rounded-lg shadow-xl max-h-48 overflow-y-auto z-10\">\n              <div className=\"p-2 text-xs text-zinc-500 border-b border-surface-3\">\n                选择要引用的字段\n              </div>\n              {filteredFields.map((field, idx) => (\n                <button\n                  key={field.id}\n                  onClick={() => insertMention(field)}\n                  className={cn(\n                    \"w-full px-3 py-2 text-left hover:bg-surface-3 flex items-center gap-2\",\n                    idx === mentionIndex && \"bg-surface-3\"\n                  )}\n                >\n                  <span className=\"text-xs text-zinc-500\">{PHASE_NAMES[field.phase] || field.phase}</span>\n                  <span className=\"text-sm text-zinc-200\">{field.name}</span>\n                </button>\n              ))}\n            </div>\n          )}\n\n          {/* Tool选择下拉 */}\n          {showTools && (\n            <div className=\"absolute bottom-full left-0 right-0 mb-1 bg-surface-2 border border-surface-3 rounded-lg shadow-xl z-10\">\n              <div className=\"p-2 text-xs text-zinc-500 border-b border-surface-3\">\n                选择要调用的工具\n              </div>\n              {AVAILABLE_TOOLS.map((tool) => (\n                <button\n                  key={tool.id}\n                  onClick={() => handleToolCall(tool.id)}\n                  className=\"w-full px-3 py-2 text-left hover:bg-surface-3\"\n                >\n                  <div className=\"text-sm text-zinc-200\">{tool.name}</div>\n                  <div className=\"text-xs text-zinc-500\">{tool.desc}</div>\n                </button>\n              ))}\n            </div>\n          )}\n\n          <div className=\"flex gap-2\">\n            <input\n              ref={inputRef}\n              type=\"text\"\n              value={input}\n              onChange={handleInputChange}\n              onKeyDown={handleKeyDown}\n              placeholder={projectId ? \"输入消息... 使用 @ 引用字段\" : \"请先选择项目\"}\n              disabled={!projectId || sending}\n              className=\"flex-1 px-4 py-2 bg-surface-2 border border-surface-3 rounded-lg text-zinc-200 placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-brand-500 disabled:opacity-50\"\n            />\n            <button\n              onClick={handleSend}\n              disabled={!projectId || !input.trim() || sending}\n              className=\"px-4 py-2 bg-brand-600 hover:bg-brand-700 disabled:bg-surface-3 disabled:cursor-not-allowed rounded-lg transition-colors\"\n            >\n              发送\n            </button>\n          </div>\n        </div>\n\n        {/* 快捷操作 */}\n        <div className=\"flex gap-2 mt-2 flex-wrap\">\n          <QuickAction label=\"继续\" onClick={() => setInput(\"继续\")} disabled={!projectId || sending} />\n          <QuickAction label=\"开始调研\" onClick={() => setInput(\"开始消费者调研\")} disabled={!projectId || sending} />\n          <QuickAction label=\"评估\" onClick={() => setInput(\"评估当前内容\")} disabled={!projectId || sending} />\n          <button\n            onClick={() => setShowTools(!showTools)}\n            disabled={!projectId || sending}\n            className=\"px-2 py-1 text-xs text-brand-400 hover:text-brand-300 hover:bg-surface-3 disabled:opacity-50 rounded transition-colors flex items-center gap-1\"\n          >\n            🔧 调用工具\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n}\n\ninterface MessageBubbleProps {\n  message: ChatMessageRecord;\n  isEditing: boolean;\n  editContent: string;\n  onEditContentChange: (content: string) => void;\n  onEdit: () => void;\n  onSaveEdit: () => void;\n  onCancelEdit: () => void;\n  onRetry: () => void;\n  onCopy: () => void;\n}\n\nfunction MessageBubble({\n  message,\n  isEditing,\n  editContent,\n  onEditContentChange,\n  onEdit,\n  onSaveEdit,\n  onCancelEdit,\n  onRetry,\n  onCopy,\n}: MessageBubbleProps) {\n  const isUser = message.role === \"user\";\n  const [showActions, setShowActions] = useState(false);\n\n  const renderContent = (content: string) => {\n    const parts = content.split(/(@[\\u4e00-\\u9fffa-zA-Z0-9_]+)/g);\n    return parts.map((part, i) => {\n      if (part.startsWith(\"@\")) {\n        return <span key={i} className=\"text-brand-400 font-medium\">{part}</span>;\n      }\n      return part;\n    });\n  };\n\n  return (\n    <div\n      className={cn(\"flex group\", isUser ? \"justify-end\" : \"justify-start\")}\n      onMouseEnter={() => setShowActions(true)}\n      onMouseLeave={() => setShowActions(false)}\n    >\n      <div className=\"relative max-w-[85%]\">\n        {/* 消息气泡 */}\n        <div\n          className={cn(\n            \"px-4 py-2 rounded-2xl\",\n            isUser\n              ? \"bg-brand-600 text-white rounded-br-md\"\n              : \"bg-surface-3 text-zinc-200 rounded-bl-md\"\n          )}\n        >\n          {isEditing ? (\n            <div className=\"space-y-2\">\n              <textarea\n                value={editContent}\n                onChange={(e) => onEditContentChange(e.target.value)}\n                className=\"w-full bg-surface-1 text-zinc-200 rounded p-2 text-sm min-h-[60px]\"\n              />\n              <div className=\"flex gap-2\">\n                <button onClick={onSaveEdit} className=\"px-2 py-1 text-xs bg-brand-600 rounded\">\n                  保存并重发\n                </button>\n                <button onClick={onCancelEdit} className=\"px-2 py-1 text-xs bg-surface-4 rounded\">\n                  取消\n                </button>\n              </div>\n            </div>\n          ) : (\n            <>\n              <div className=\"whitespace-pre-wrap text-sm\">\n                {renderContent(message.content)}\n              </div>\n              {message.is_edited && (\n                <span className=\"text-xs opacity-50 ml-1\">(已编辑)</span>\n              )}\n              {message.metadata?.tool_used && (\n                <span className=\"text-xs opacity-70 block mt-1\">\n                  🔧 {message.metadata.tool_used}\n                </span>\n              )}\n            </>\n          )}\n        </div>\n\n        {/* 操作按钮 */}\n        {showActions && !isEditing && (\n          <div\n            className={cn(\n              \"absolute top-0 flex gap-1 bg-surface-2 rounded-lg shadow-lg p-1 z-10\",\n              isUser ? \"left-0 -translate-x-full -ml-2\" : \"right-0 translate-x-full ml-2\"\n            )}\n          >\n            <ActionButton icon=\"📋\" title=\"复制\" onClick={onCopy} />\n            {isUser && <ActionButton icon=\"✏️\" title=\"编辑重发\" onClick={onEdit} />}\n            {!isUser && <ActionButton icon=\"🔄\" title=\"再试一次\" onClick={onRetry} />}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n\nfunction ActionButton({ icon, title, onClick }: { icon: string; title: string; onClick: () => void }) {\n  return (\n    <button\n      onClick={onClick}\n      title={title}\n      className=\"w-6 h-6 flex items-center justify-center text-xs hover:bg-surface-3 rounded transition-colors\"\n    >\n      {icon}\n    </button>\n  );\n}\n\nfunction QuickAction({ label, onClick, disabled }: { label: string; onClick: () => void; disabled: boolean }) {\n  return (\n    <button\n      onClick={onClick}\n      disabled={disabled}\n      className=\"px-2 py-1 text-xs text-zinc-400 hover:text-zinc-200 hover:bg-surface-3 disabled:opacity-50 disabled:cursor-not-allowed rounded transition-colors\"\n    >\n      {label}\n    </button>\n  );\n}\n"],"names":[],"mappings":";;;;;AAOA;AACA;AACA;;;AATA,sCAAsC;AACtC,qBAAqB;AACrB,iEAAiE;AACjE,uCAAuC;AAEvC;;;;AAeA,YAAY;AACZ,MAAM,kBAAkB;IACtB;QAAE,IAAI;QAAiB,MAAM;QAAQ,MAAM;IAAuB;IAClE;QAAE,IAAI;QAAkB,MAAM;QAAQ,MAAM;IAAgB;IAC5D;QAAE,IAAI;QAAqB,MAAM;QAAS,MAAM;IAAY;IAC5D;QAAE,IAAI;QAAoB,MAAM;QAAQ,MAAM;IAAS;CACxD;AAEM,SAAS,WAAW,EACzB,SAAS,EACT,SAAS,EAAE,EACX,aAAa,EACb,eAAe,EACf,YAAY,KAAK,EACD;;IAChB,MAAM,CAAC,UAAU,YAAY,GAAG,IAAA,yKAAQ,EAAsB,EAAE;IAChE,MAAM,CAAC,OAAO,SAAS,GAAG,IAAA,yKAAQ,EAAC;IACnC,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,yKAAQ,EAAC;IACvC,MAAM,CAAC,cAAc,gBAAgB,GAAG,IAAA,yKAAQ,EAAC;IACjD,MAAM,CAAC,WAAW,aAAa,GAAG,IAAA,yKAAQ,EAAC;IAC3C,MAAM,CAAC,eAAe,iBAAiB,GAAG,IAAA,yKAAQ,EAAC;IACnD,MAAM,CAAC,cAAc,gBAAgB,GAAG,IAAA,yKAAQ,EAAC;IACjD,MAAM,CAAC,gBAAgB,kBAAkB,GAAG,IAAA,yKAAQ,EAAC;IACrD,MAAM,CAAC,kBAAkB,oBAAoB,GAAG,IAAA,yKAAQ,EAAgB;IACxE,MAAM,CAAC,aAAa,eAAe,GAAG,IAAA,yKAAQ,EAAC;IAE/C,MAAM,iBAAiB,IAAA,uKAAM,EAAiB;IAC9C,MAAM,WAAW,IAAA,uKAAM,EAAmB;IAC1C,MAAM,kBAAkB,IAAA,uKAAM,EAAS,CAAC;IAExC,MAAM,kBAAkB,OAAO,MAAM,CAAC,CAAC,IAAM,EAAE,MAAM,KAAK;IAC1D,MAAM,iBAAiB,gBAAgB,MAAM,CAAC,CAAC,IAC7C,EAAE,IAAI,CAAC,WAAW,GAAG,QAAQ,CAAC,cAAc,WAAW,OACvD,EAAE,KAAK,CAAC,WAAW,GAAG,QAAQ,CAAC,cAAc,WAAW;IAG1D,SAAS;IACT,IAAA,0KAAS;gCAAC;YACR,IAAI,WAAW;gBACb;YACF,OAAO;gBACL,YAAY,EAAE;YAChB;QACF;+BAAG;QAAC;KAAU;IAEd,OAAO;IACP,IAAA,0KAAS;gCAAC;YACR,eAAe,OAAO,EAAE,eAAe;gBAAE,UAAU;YAAS;QAC9D;+BAAG;QAAC;KAAS;IAEb,MAAM,cAAc;QAClB,IAAI,CAAC,WAAW;QAChB,IAAI;YACF,MAAM,UAAU,MAAM,yHAAQ,CAAC,UAAU,CAAC;YAC1C,YAAY;QACd,EAAE,OAAO,KAAK;YACZ,QAAQ,KAAK,CAAC,aAAa;QAC7B;IACF;IAEA,MAAM,gBAAgB,IAAA,4KAAW;iDAAC,CAAC;YACjC,MAAM,gBAAgB,MAAM,KAAK,CAAC,GAAG,gBAAgB,OAAO;YAC5D,MAAM,eAAe,MAAM,KAAK,CAAC;YACjC,MAAM,WAAW,GAAG,cAAc,CAAC,EAAE,MAAM,IAAI,GAAG,cAAc;YAChE,SAAS;YACT,gBAAgB;YAChB,iBAAiB;YACjB,gBAAgB,OAAO,GAAG,CAAC;YAC3B;yDAAW,IAAM,SAAS,OAAO,EAAE;wDAAS;QAC9C;gDAAG;QAAC;QAAO;KAAe;IAE1B,MAAM,oBAAoB,CAAC;QACzB,MAAM,QAAQ,EAAE,MAAM,CAAC,KAAK;QAC5B,MAAM,iBAAiB,EAAE,MAAM,CAAC,cAAc,IAAI;QAClD,SAAS;QACT,kBAAkB;QAElB,MAAM,YAAY,MAAM,WAAW,CAAC,KAAK,iBAAiB;QAC1D,IAAI,cAAc,CAAC,GAAG;YACpB,MAAM,cAAc,MAAM,KAAK,CAAC,YAAY,GAAG;YAC/C,IAAI,CAAC,YAAY,QAAQ,CAAC,MAAM;gBAC9B,gBAAgB,OAAO,GAAG;gBAC1B,iBAAiB;gBACjB,gBAAgB;gBAChB,gBAAgB;gBAChB;YACF;QACF;QACA,gBAAgB;QAChB,iBAAiB;IACnB;IAEA,MAAM,gBAAgB,CAAC;QACrB,IAAI,gBAAgB,eAAe,MAAM,GAAG,GAAG;YAC7C,IAAI,EAAE,GAAG,KAAK,aAAa;gBACzB,EAAE,cAAc;gBAChB,gBAAgB,CAAC,OAAS,CAAC,OAAO,CAAC,IAAI,eAAe,MAAM;gBAC5D;YACF;YACA,IAAI,EAAE,GAAG,KAAK,WAAW;gBACvB,EAAE,cAAc;gBAChB,gBAAgB,CAAC,OAAS,CAAC,OAAO,IAAI,eAAe,MAAM,IAAI,eAAe,MAAM;gBACpF;YACF;YACA,IAAI,EAAE,GAAG,KAAK,WAAW,EAAE,GAAG,KAAK,OAAO;gBACxC,EAAE,cAAc;gBAChB,cAAc,cAAc,CAAC,aAAa;gBAC1C;YACF;YACA,IAAI,EAAE,GAAG,KAAK,UAAU;gBACtB,gBAAgB;gBAChB;YACF;QACF;QAEA,IAAI,EAAE,GAAG,KAAK,WAAW,CAAC,EAAE,QAAQ,IAAI,CAAC,cAAc;YACrD,EAAE,cAAc;YAChB;QACF;IACF;IAEA,MAAM,aAAa;QACjB,IAAI,CAAC,MAAM,IAAI,MAAM,CAAC,aAAa,SAAS;QAE5C,MAAM,cAAc,MAAM,IAAI;QAC9B,SAAS;QACT,WAAW;QACX,gBAAgB;QAEhB,iBAAiB;QACjB,MAAM,cAAiC;YACrC,IAAI,CAAC,KAAK,EAAE,KAAK,GAAG,IAAI;YACxB,MAAM;YACN,SAAS;YACT,kBAAkB;YAClB,WAAW;YACX,UAAU,CAAC;YACX,YAAY,IAAI,OAAO,WAAW;QACpC;QACA,YAAY,CAAC,OAAS;mBAAI;gBAAM;aAAY;QAE5C,IAAI;YACF,MAAM,WAAW,MAAM,yHAAQ,CAAC,IAAI,CAAC,WAAW;YAChD,8BAA8B;YAC9B,MAAM;YAEN,eAAe;YACf,IAAI,iBAAiB;gBACnB;YACF;QACF,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,SAAS;YACvB,cAAc;YACd,YAAY,CAAC,OAAS,KAAK,MAAM,CAAC,CAAC,IAAM,EAAE,EAAE,KAAK,YAAY,EAAE;QAClE,SAAU;YACR,WAAW;QACb;IACF;IAEA,MAAM,cAAc,OAAO;QACzB,IAAI,CAAC,WAAW;QAChB,WAAW;QACX,IAAI;YACF,MAAM,yHAAQ,CAAC,YAAY,CAAC;YAC5B,MAAM;QACR,EAAE,OAAO,KAAK;YACZ,QAAQ,KAAK,CAAC,SAAS;QACzB,SAAU;YACR,WAAW;QACb;IACF;IAEA,MAAM,aAAa,CAAC;QAClB,oBAAoB,QAAQ,EAAE;QAC9B,eAAe,QAAQ,OAAO;IAChC;IAEA,MAAM,iBAAiB;QACrB,IAAI,CAAC,oBAAoB,CAAC,aAAa,SAAS;QAEhD,WAAW,OAAQ,cAAc;QACjC,oBAAoB,OAAQ,UAAU;QAEtC,IAAI;YACF,MAAM,yHAAQ,CAAC,WAAW,CAAC,kBAAkB;YAC7C,UAAU;YACV,MAAM,WAAW,MAAM,yHAAQ,CAAC,IAAI,CAAC,WAAW;YAChD,MAAM;YAEN,UAAU;YACV,IAAI,iBAAiB;gBACnB;YACF;QACF,EAAE,OAAO,KAAK;YACZ,QAAQ,KAAK,CAAC,SAAS;QACzB,SAAU;YACR,WAAW;YACX,eAAe;QACjB;IACF;IAEA,MAAM,aAAa,OAAO;QACxB,IAAI;YACF,MAAM,UAAU,SAAS,CAAC,SAAS,CAAC;QACpC,cAAc;QAChB,EAAE,OAAO,KAAK;YACZ,QAAQ,KAAK,CAAC,SAAS;QACzB;IACF;IAEA,MAAM,iBAAiB,OAAO;QAC5B,IAAI,CAAC,WAAW;QAChB,aAAa;QACb,WAAW;QAEX,IAAI;YACF,MAAM,yHAAQ,CAAC,QAAQ,CAAC,WAAW,QAAQ,CAAC;YAC5C,MAAM;QACR,EAAE,OAAO,KAAK;YACZ,QAAQ,KAAK,CAAC,aAAa;QAC7B,SAAU;YACR,WAAW;QACb;IACF;IAEA,qBACE,6LAAC;QAAI,WAAU;;0BAEb,6LAAC;gBAAI,WAAU;;kCACb,6LAAC;wBAAG,WAAU;kCAA8B;;;;;;kCAC5C,6LAAC;wBAAE,WAAU;kCACV,YAAY,qBAAqB;;;;;;;;;;;;0BAKtC,6LAAC;gBAAI,WAAU;;oBACZ,SAAS,MAAM,KAAK,mBACnB,6LAAC;wBAAI,WAAU;;0CACb,6LAAC;0CAAE;;;;;;0CACH,6LAAC;gCAAE,WAAU;0CAAe;;;;;;;;;;;;oBAM/B,SAAS,GAAG,CAAC,CAAC,oBACb,6LAAC;4BAEC,SAAS;4BACT,WAAW,qBAAqB,IAAI,EAAE;4BACtC,aAAa;4BACb,qBAAqB;4BACrB,QAAQ,IAAM,WAAW;4BACzB,YAAY;4BACZ,cAAc,IAAM,oBAAoB;4BACxC,SAAS,IAAM,YAAY,IAAI,EAAE;4BACjC,QAAQ,IAAM,WAAW,IAAI,OAAO;2BAT/B,IAAI,EAAE;;;;;oBAad,yBACC,6LAAC;wBAAI,WAAU;;0CACb,6LAAC;gCAAI,WAAU;;;;;;0CACf,6LAAC;gCAAK,WAAU;0CAAU;;;;;;;;;;;;kCAI9B,6LAAC;wBAAI,KAAK;;;;;;;;;;;;0BAIZ,6LAAC;gBAAI,WAAU;;kCACb,6LAAC;wBAAI,WAAU;;4BAEZ,gBAAgB,eAAe,MAAM,GAAG,mBACvC,6LAAC;gCAAI,WAAU;;kDACb,6LAAC;wCAAI,WAAU;kDAAsD;;;;;;oCAGpE,eAAe,GAAG,CAAC,CAAC,OAAO,oBAC1B,6LAAC;4CAEC,SAAS,IAAM,cAAc;4CAC7B,WAAW,IAAA,qHAAE,EACX,yEACA,QAAQ,gBAAgB;;8DAG1B,6LAAC;oDAAK,WAAU;8DAAyB,8HAAW,CAAC,MAAM,KAAK,CAAC,IAAI,MAAM,KAAK;;;;;;8DAChF,6LAAC;oDAAK,WAAU;8DAAyB,MAAM,IAAI;;;;;;;2CAR9C,MAAM,EAAE;;;;;;;;;;;4BAepB,2BACC,6LAAC;gCAAI,WAAU;;kDACb,6LAAC;wCAAI,WAAU;kDAAsD;;;;;;oCAGpE,gBAAgB,GAAG,CAAC,CAAC,qBACpB,6LAAC;4CAEC,SAAS,IAAM,eAAe,KAAK,EAAE;4CACrC,WAAU;;8DAEV,6LAAC;oDAAI,WAAU;8DAAyB,KAAK,IAAI;;;;;;8DACjD,6LAAC;oDAAI,WAAU;8DAAyB,KAAK,IAAI;;;;;;;2CAL5C,KAAK,EAAE;;;;;;;;;;;0CAWpB,6LAAC;gCAAI,WAAU;;kDACb,6LAAC;wCACC,KAAK;wCACL,MAAK;wCACL,OAAO;wCACP,UAAU;wCACV,WAAW;wCACX,aAAa,YAAY,sBAAsB;wCAC/C,UAAU,CAAC,aAAa;wCACxB,WAAU;;;;;;kDAEZ,6LAAC;wCACC,SAAS;wCACT,UAAU,CAAC,aAAa,CAAC,MAAM,IAAI,MAAM;wCACzC,WAAU;kDACX;;;;;;;;;;;;;;;;;;kCAOL,6LAAC;wBAAI,WAAU;;0CACb,6LAAC;gCAAY,OAAM;gCAAK,SAAS,IAAM,SAAS;gCAAO,UAAU,CAAC,aAAa;;;;;;0CAC/E,6LAAC;gCAAY,OAAM;gCAAO,SAAS,IAAM,SAAS;gCAAY,UAAU,CAAC,aAAa;;;;;;0CACtF,6LAAC;gCAAY,OAAM;gCAAK,SAAS,IAAM,SAAS;gCAAW,UAAU,CAAC,aAAa;;;;;;0CACnF,6LAAC;gCACC,SAAS,IAAM,aAAa,CAAC;gCAC7B,UAAU,CAAC,aAAa;gCACxB,WAAU;0CACX;;;;;;;;;;;;;;;;;;;;;;;;AAOX;GAxVgB;KAAA;AAsWhB,SAAS,cAAc,EACrB,OAAO,EACP,SAAS,EACT,WAAW,EACX,mBAAmB,EACnB,MAAM,EACN,UAAU,EACV,YAAY,EACZ,OAAO,EACP,MAAM,EACa;;IACnB,MAAM,SAAS,QAAQ,IAAI,KAAK;IAChC,MAAM,CAAC,aAAa,eAAe,GAAG,IAAA,yKAAQ,EAAC;IAE/C,MAAM,gBAAgB,CAAC;QACrB,MAAM,QAAQ,QAAQ,KAAK,CAAC;QAC5B,OAAO,MAAM,GAAG,CAAC,CAAC,MAAM;YACtB,IAAI,KAAK,UAAU,CAAC,MAAM;gBACxB,qBAAO,6LAAC;oBAAa,WAAU;8BAA8B;mBAA3C;;;;;YACpB;YACA,OAAO;QACT;IACF;IAEA,qBACE,6LAAC;QACC,WAAW,IAAA,qHAAE,EAAC,cAAc,SAAS,gBAAgB;QACrD,cAAc,IAAM,eAAe;QACnC,cAAc,IAAM,eAAe;kBAEnC,cAAA,6LAAC;YAAI,WAAU;;8BAEb,6LAAC;oBACC,WAAW,IAAA,qHAAE,EACX,yBACA,SACI,0CACA;8BAGL,0BACC,6LAAC;wBAAI,WAAU;;0CACb,6LAAC;gCACC,OAAO;gCACP,UAAU,CAAC,IAAM,oBAAoB,EAAE,MAAM,CAAC,KAAK;gCACnD,WAAU;;;;;;0CAEZ,6LAAC;gCAAI,WAAU;;kDACb,6LAAC;wCAAO,SAAS;wCAAY,WAAU;kDAAyC;;;;;;kDAGhF,6LAAC;wCAAO,SAAS;wCAAc,WAAU;kDAAyC;;;;;;;;;;;;;;;;;6CAMtF;;0CACE,6LAAC;gCAAI,WAAU;0CACZ,cAAc,QAAQ,OAAO;;;;;;4BAE/B,QAAQ,SAAS,kBAChB,6LAAC;gCAAK,WAAU;0CAA0B;;;;;;4BAE3C,QAAQ,QAAQ,EAAE,2BACjB,6LAAC;gCAAK,WAAU;;oCAAgC;oCAC1C,QAAQ,QAAQ,CAAC,SAAS;;;;;;;;;;;;;;gBAQvC,eAAe,CAAC,2BACf,6LAAC;oBACC,WAAW,IAAA,qHAAE,EACX,wEACA,SAAS,mCAAmC;;sCAG9C,6LAAC;4BAAa,MAAK;4BAAK,OAAM;4BAAK,SAAS;;;;;;wBAC3C,wBAAU,6LAAC;4BAAa,MAAK;4BAAK,OAAM;4BAAO,SAAS;;;;;;wBACxD,CAAC,wBAAU,6LAAC;4BAAa,MAAK;4BAAK,OAAM;4BAAO,SAAS;;;;;;;;;;;;;;;;;;;;;;;AAMtE;IAzFS;MAAA;AA2FT,SAAS,aAAa,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAwD;IAClG,qBACE,6LAAC;QACC,SAAS;QACT,OAAO;QACP,WAAU;kBAET;;;;;;AAGP;MAVS;AAYT,SAAS,YAAY,EAAE,KAAK,EAAE,OAAO,EAAE,QAAQ,EAA6D;IAC1G,qBACE,6LAAC;QACC,SAAS;QACT,UAAU;QACV,WAAU;kBAET;;;;;;AAGP;MAVS"}},
    {"offset": {"line": 3290, "column": 0}, "map": {"version":3,"sources":["file:///D:/G/vibe_projects/202601_content_production_system_2/frontend/components/create-project-modal.tsx"],"sourcesContent":["// frontend/components/create-project-modal.tsx\r\n// 功能: 创建项目对话框，包含创作者特质选择和DeepResearch开关\r\n\r\n\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { settingsAPI, projectAPI } from \"@/lib/api\";\r\nimport type { CreatorProfile, Project } from \"@/lib/api\";\r\n\r\ninterface CreateProjectModalProps {\r\n  isOpen: boolean;\r\n  onClose: () => void;\r\n  onCreated: (project: Project) => void;\r\n}\r\n\r\nexport function CreateProjectModal({\r\n  isOpen,\r\n  onClose,\r\n  onCreated,\r\n}: CreateProjectModalProps) {\r\n  const [name, setName] = useState(\"\");\r\n  const [creatorProfileId, setCreatorProfileId] = useState<string>(\"\");\r\n  const [useDeepResearch, setUseDeepResearch] = useState(true);\r\n  const [creatorProfiles, setCreatorProfiles] = useState<CreatorProfile[]>([]);\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  // 加载创作者特质列表\r\n  useEffect(() => {\r\n    if (isOpen) {\r\n      loadCreatorProfiles();\r\n    }\r\n  }, [isOpen]);\r\n\r\n  const loadCreatorProfiles = async () => {\r\n    try {\r\n      const profiles = await settingsAPI.listCreatorProfiles();\r\n      setCreatorProfiles(profiles);\r\n      // 如果有默认的，自动选中第一个\r\n      if (profiles.length > 0 && !creatorProfileId) {\r\n        setCreatorProfileId(profiles[0].id);\r\n      }\r\n    } catch (err) {\r\n      console.error(\"加载创作者特质失败:\", err);\r\n    }\r\n  };\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    \r\n    if (!name.trim()) {\r\n      setError(\"请输入项目名称\");\r\n      return;\r\n    }\r\n    \r\n    if (!creatorProfileId) {\r\n      setError(\"请选择创作者特质\");\r\n      return;\r\n    }\r\n\r\n    setLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      const project = await projectAPI.create({\r\n        name: name.trim(),\r\n        creator_profile_id: creatorProfileId,\r\n        use_deep_research: useDeepResearch,\r\n      });\r\n      onCreated(project);\r\n      // 重置表单\r\n      setName(\"\");\r\n      setCreatorProfileId(creatorProfiles[0]?.id || \"\");\r\n      setUseDeepResearch(true);\r\n      onClose();\r\n    } catch (err) {\r\n      setError(err instanceof Error ? err.message : \"创建失败\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  if (!isOpen) return null;\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center\">\r\n      {/* 背景遮罩 */}\r\n      <div\r\n        className=\"absolute inset-0 bg-black/60 backdrop-blur-sm\"\r\n        onClick={onClose}\r\n      />\r\n\r\n      {/* 对话框 */}\r\n      <div className=\"relative w-full max-w-md bg-surface-1 border border-surface-3 rounded-xl shadow-2xl\">\r\n        <div className=\"p-6\">\r\n          <h2 className=\"text-xl font-semibold text-zinc-100 mb-6\">\r\n            新建内容项目\r\n          </h2>\r\n\r\n          <form onSubmit={handleSubmit} className=\"space-y-5\">\r\n            {/* 项目名称 */}\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-zinc-300 mb-2\">\r\n                项目名称 <span className=\"text-red-400\">*</span>\r\n              </label>\r\n              <input\r\n                type=\"text\"\r\n                value={name}\r\n                onChange={(e) => setName(e.target.value)}\r\n                placeholder=\"例如：产品发布内容策划\"\r\n                className=\"w-full px-4 py-2.5 bg-surface-2 border border-surface-3 rounded-lg text-zinc-100 placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent\"\r\n                autoFocus\r\n              />\r\n            </div>\r\n\r\n            {/* 创作者特质 */}\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-zinc-300 mb-2\">\r\n                创作者特质 <span className=\"text-red-400\">*</span>\r\n              </label>\r\n              {creatorProfiles.length === 0 ? (\r\n                <div className=\"p-4 bg-amber-900/20 border border-amber-700/50 rounded-lg\">\r\n                  <p className=\"text-sm text-amber-200\">\r\n                    还没有创作者特质，请先在{\" \"}\r\n                    <a\r\n                      href=\"/settings\"\r\n                      className=\"underline hover:text-amber-100\"\r\n                    >\r\n                      后台设置\r\n                    </a>{\" \"}\r\n                    中创建。\r\n                  </p>\r\n                </div>\r\n              ) : (\r\n                <select\r\n                  value={creatorProfileId}\r\n                  onChange={(e) => setCreatorProfileId(e.target.value)}\r\n                  className=\"w-full px-4 py-2.5 bg-surface-2 border border-surface-3 rounded-lg text-zinc-100 focus:outline-none focus:ring-2 focus:ring-brand-500\"\r\n                >\r\n                  <option value=\"\">请选择...</option>\r\n                  {creatorProfiles.map((profile) => (\r\n                    <option key={profile.id} value={profile.id}>\r\n                      {profile.name}\r\n                    </option>\r\n                  ))}\r\n                </select>\r\n              )}\r\n              {creatorProfileId && (\r\n                <p className=\"mt-2 text-xs text-zinc-500\">\r\n                  创作者特质将作为所有内容生成的全局上下文\r\n                </p>\r\n              )}\r\n            </div>\r\n\r\n            {/* DeepResearch 开关 */}\r\n            <div className=\"flex items-center justify-between p-4 bg-surface-2 rounded-lg\">\r\n              <div>\r\n                <p className=\"text-sm font-medium text-zinc-200\">\r\n                  启用 DeepResearch\r\n                </p>\r\n                <p className=\"text-xs text-zinc-500 mt-1\">\r\n                  消费者调研阶段将使用网络搜索获取更深入的用户洞察\r\n                </p>\r\n              </div>\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => setUseDeepResearch(!useDeepResearch)}\r\n                className={`relative w-12 h-6 rounded-full transition-colors ${\r\n                  useDeepResearch ? \"bg-brand-600\" : \"bg-zinc-600\"\r\n                }`}\r\n              >\r\n                <span\r\n                  className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform ${\r\n                    useDeepResearch ? \"left-7\" : \"left-1\"\r\n                  }`}\r\n                />\r\n              </button>\r\n            </div>\r\n\r\n            {/* 错误提示 */}\r\n            {error && (\r\n              <div className=\"p-3 bg-red-900/20 border border-red-700/50 rounded-lg\">\r\n                <p className=\"text-sm text-red-300\">{error}</p>\r\n              </div>\r\n            )}\r\n\r\n            {/* 按钮 */}\r\n            <div className=\"flex justify-end gap-3 pt-2\">\r\n              <button\r\n                type=\"button\"\r\n                onClick={onClose}\r\n                className=\"px-4 py-2 text-sm text-zinc-400 hover:text-zinc-200 transition-colors\"\r\n              >\r\n                取消\r\n              </button>\r\n              <button\r\n                type=\"submit\"\r\n                disabled={loading || !name.trim() || !creatorProfileId}\r\n                className=\"px-5 py-2 text-sm bg-brand-600 hover:bg-brand-700 disabled:opacity-50 disabled:cursor-not-allowed rounded-lg transition-colors\"\r\n              >\r\n                {loading ? \"创建中...\" : \"创建项目\"}\r\n              </button>\r\n            </div>\r\n          </form>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3648, "column": 0}, "map": {"version":3,"sources":["file:///D:/G/vibe_projects/202601_content_production_system_2/frontend/app/workspace/page.tsx"],"sourcesContent":["// frontend/app/workspace/page.tsx\n// 功能: 内容生产工作台主页面\n// 主要组件: WorkspacePage\n\n\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport { WorkspaceLayout } from \"@/components/layout/workspace-layout\";\nimport { ProgressPanel } from \"@/components/progress-panel\";\nimport { ContentPanel } from \"@/components/content-panel\";\nimport { AgentPanel } from \"@/components/agent-panel\";\nimport { CreateProjectModal } from \"@/components/create-project-modal\";\nimport { projectAPI, fieldAPI, agentAPI } from \"@/lib/api\";\nimport type { Project, Field } from \"@/lib/api\";\n\nexport default function WorkspacePage() {\n  const [projects, setProjects] = useState<Project[]>([]);\n  const [currentProject, setCurrentProject] = useState<Project | null>(null);\n  const [fields, setFields] = useState<Field[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [showCreateModal, setShowCreateModal] = useState(false);\n\n  // 加载项目列表\n  useEffect(() => {\n    loadProjects();\n  }, []);\n\n  // 加载当前项目的字段\n  useEffect(() => {\n    if (currentProject) {\n      loadFields(currentProject.id);\n    }\n  }, [currentProject?.id]);\n\n  const loadProjects = async () => {\n    try {\n      const data = await projectAPI.list();\n      setProjects(data);\n      \n      // 自动选择第一个项目\n      if (data.length > 0 && !currentProject) {\n        setCurrentProject(data[0]);\n      }\n    } catch (err) {\n      setError(err instanceof Error ? err.message : \"加载项目失败\");\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const loadFields = async (projectId: string) => {\n    try {\n      const data = await fieldAPI.listByProject(projectId);\n      setFields(data);\n    } catch (err) {\n      console.error(\"加载字段失败:\", err);\n    }\n  };\n\n  const handlePhaseClick = (phase: string) => {\n    if (currentProject) {\n      setCurrentProject({\n        ...currentProject,\n        current_phase: phase,\n      });\n    }\n  };\n\n  const handlePhaseReorder = async (newPhaseOrder: string[]) => {\n    if (!currentProject) return;\n    \n    try {\n      // 更新本地状态\n      setCurrentProject({\n        ...currentProject,\n        phase_order: newPhaseOrder,\n      });\n      \n      // 保存到服务器\n      await projectAPI.update(currentProject.id, { phase_order: newPhaseOrder });\n    } catch (err) {\n      console.error(\"更新阶段顺序失败:\", err);\n    }\n  };\n\n  const handleAutonomyChange = async (autonomy: Record<string, boolean>) => {\n    if (!currentProject) return;\n    \n    try {\n      // 更新本地状态\n      setCurrentProject({\n        ...currentProject,\n        agent_autonomy: autonomy,\n      });\n      \n      // 保存到服务器\n      await projectAPI.update(currentProject.id, { agent_autonomy: autonomy });\n    } catch (err) {\n      console.error(\"更新自主权设置失败:\", err);\n    }\n  };\n\n  const handleFieldUpdate = async (fieldId: string, content: string) => {\n    try {\n      await fieldAPI.update(fieldId, { content });\n      // 重新加载字段\n      if (currentProject) {\n        loadFields(currentProject.id);\n      }\n    } catch (err) {\n      console.error(\"更新字段失败:\", err);\n    }\n  };\n\n  const handleSendMessage = async (message: string): Promise<string> => {\n    if (!currentProject) {\n      throw new Error(\"请先选择项目\");\n    }\n\n    const response = await agentAPI.chat(\n      currentProject.id,\n      message,\n      currentProject.current_phase\n    );\n\n    // 更新项目状态\n    if (response.phase_status) {\n      setCurrentProject({\n        ...currentProject,\n        phase_status: response.phase_status,\n      });\n    }\n\n    // 重新加载字段\n    loadFields(currentProject.id);\n\n    return response.message;\n  };\n\n  const handleCreateProject = () => {\n    setShowCreateModal(true);\n  };\n\n  const handleProjectCreated = (project: Project) => {\n    setProjects([...projects, project]);\n    setCurrentProject(project);\n  };\n\n  if (loading) {\n    return (\n      <div className=\"flex items-center justify-center h-screen bg-surface-0\">\n        <div className=\"text-zinc-400\">加载中...</div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"h-screen flex flex-col\">\n      {/* 顶部导航 */}\n      <header className=\"h-14 flex-shrink-0 border-b border-surface-3 bg-surface-1 flex items-center justify-between px-4\">\n        <div className=\"flex items-center gap-4\">\n          <h1 className=\"text-lg font-semibold bg-gradient-to-r from-brand-400 to-brand-600 bg-clip-text text-transparent\">\n            内容生产系统\n          </h1>\n          \n          {/* 项目选择器 */}\n          <select\n            value={currentProject?.id || \"\"}\n            onChange={(e) => {\n              const project = projects.find((p) => p.id === e.target.value);\n              setCurrentProject(project || null);\n            }}\n            className=\"px-3 py-1.5 bg-surface-2 border border-surface-3 rounded-lg text-sm text-zinc-200 focus:outline-none focus:ring-2 focus:ring-brand-500\"\n          >\n            <option value=\"\">选择项目</option>\n            {projects.map((p) => (\n              <option key={p.id} value={p.id}>\n                {p.name} (v{p.version})\n              </option>\n            ))}\n          </select>\n          \n          <button\n            onClick={handleCreateProject}\n            className=\"px-3 py-1.5 text-sm bg-brand-600 hover:bg-brand-700 rounded-lg transition-colors\"\n          >\n            + 新建项目\n          </button>\n        </div>\n\n        <div className=\"flex items-center gap-4\">\n          <a\n            href=\"/settings\"\n            className=\"text-sm text-zinc-400 hover:text-zinc-200 transition-colors\"\n          >\n            后台设置\n          </a>\n        </div>\n      </header>\n\n      {/* 三栏布局 */}\n      <div className=\"flex-1 overflow-hidden\">\n        <WorkspaceLayout\n          leftPanel={\n            <ProgressPanel\n              project={currentProject}\n              onPhaseClick={handlePhaseClick}\n              onPhaseReorder={handlePhaseReorder}\n              onAutonomyChange={handleAutonomyChange}\n            />\n          }\n          centerPanel={\n            <ContentPanel\n              projectId={currentProject?.id || null}\n              currentPhase={currentProject?.current_phase || \"intent\"}\n              fields={fields}\n              onFieldUpdate={handleFieldUpdate}\n              onFieldsChange={() => currentProject && loadFields(currentProject.id)}\n            />\n          }\n          rightPanel={\n            <AgentPanel\n              projectId={currentProject?.id || null}\n              fields={fields}\n              onSendMessage={handleSendMessage}\n              onContentUpdate={async () => {\n                // Agent生成内容后，刷新字段和项目状态\n                if (currentProject) {\n                  await loadFields(currentProject.id);\n                  // 重新加载项目以获取最新的phase_status\n                  const updatedProject = await projectAPI.get(currentProject.id);\n                  setCurrentProject(updatedProject);\n                }\n              }}\n            />\n          }\n        />\n      </div>\n\n      {/* 错误提示 */}\n      {error && (\n        <div className=\"fixed bottom-4 right-4 px-4 py-2 bg-red-600 text-white rounded-lg\">\n          {error}\n          <button\n            onClick={() => setError(null)}\n            className=\"ml-2 text-red-200 hover:text-white\"\n          >\n            ✕\n          </button>\n        </div>\n      )}\n\n      {/* 创建项目对话框 */}\n      <CreateProjectModal\n        isOpen={showCreateModal}\n        onClose={() => setShowCreateModal(false)}\n        onCreated={handleProjectCreated}\n      />\n    </div>\n  );\n}\n\n"],"names":[],"mappings":"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"}}]
}